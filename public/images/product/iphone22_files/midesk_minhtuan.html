
<!-- saved from url=(0863)https://demo-2021.midesk.vn/supportchat/widget/midesk_minhtuan.php?d=eyJncm91cCI6IjEwMyIsInRpdGxlX3dlYiI6IlNlYXJjaDogaXBob25lIDE1IC0gTWluaCBUdeG6pW4gTW9iaWxlIiwibGlua19wb3J0YWwiOiJodHRwczovL2RlbW8tMjAyMS5taWRlc2sudm4vc3VwcG9ydGNoYXQvd2lkZ2V0IiwiaG9zdF9uYW1lIjoibWluaHR1YW5tb2JpbGUuY29tIiwiY3VycmVudF91cmwiOiJodHRwczovL21pbmh0dWFubW9iaWxlLmNvbS9zZWFyY2gvP2s9aXBob25lKzE1IiwicmVmX3VybCI6Imh0dHBzOi8vbWluaHR1YW5tb2JpbGUuY29tL21hY2Jvb2stYWlyLW0yLTEzLTYtaW5jaC0yMDIyLWNoaXAtbTItOGNwdS0xMGdwdS01MTJnYi1yYW0tOGdiLyIsIm9zIjoiV2luZG93cyAxMCIsImJyb3dzZXIiOiJDaHJvbWUgMTE1ICgxMTUuMC4wLjApIiwibW9iaWxlIjpmYWxzZSwic2NyZWVuX3NpemUiOiIxMjgwIHggNzIwIiwiaXBfYWRkcmVzcyI6IjEwLjEwLjEwMy4yNTAiLCJjb29raWVzIjp0cnVlLCJjb29raWVfd2lkZ2V0IjoiZGQ1MTlhOTctYWIwMi00NDlkLTkzZGQtMzRjYTkzYmRlYWFjIiwibGFuZyI6InZpIiwiaGFzaCI6Ik1USXpORFUyIiwib3JpZ2luIjoiaHR0cHM6Ly9taW5odHVhbm1vYmlsZS5jb206In0%3D -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript">
var jsThemeConfig = {"trackPages":"false","themeName":"default","headerColor":"#eb2a1e","headerGradient":"","widgetBorder":"","widgetShadow":"true","widgetRadius":"0px","headerText":"CHAT WITH LOVE","chatInviteMessage":"We will be happy to help you out. Please enter your name below to start talking to us.","testColor":"border:1px solid #0ac6aa","adminOrientation":"right","headerStyle":"operator","triggerMethod":"default","themeSelect":"2","backgroundColor":"#fcfcfc","adminAvatarSelect":"img","userAvatarSelect":"img","adminAvatarFile":"set_1_2.jpg","userAvatarFile":"https:\/\/support.siridesk.vn\/supportchat\/data\/config\/themes\/img\/avatars\/set_7\/1.png","userAvatarSet":"set_7","avatar_set_files":["1.png","10.png","11.png","12.png","13.png","14.png","15.png","2.png","3.png","4.png","5.png","6.png","7.png","8.png","9.png"],"widgetButtonColor":"#eb2a1e","widgetButtonColorGradient":"","widgetButtonColorIcon":"#ffffff","file":"","headerTextM1":"H\u1ed7 tr\u1ee3 tr\u1ef1c tuy\u1ebfn","headerTextColor":"#fff","initMsgModule_1":"Ch\u00e0o m\u1eebng \u0111\u1ebfn LiveChat ! Vui l\u00f2ng ho\u00e0n th\u00e0nh m\u1eabu sau \u0111\u00e2y tr\u01b0\u1edbc khi b\u1eaft \u0111\u1ea7u chat. ","initMsgColor":"#666666","chatBtnMsgBackgroundColor":"#eb2a1e","chatBtnMsgBackgroundGradient":"","chatBtnMsg":"B\u1eaeT \u0110\u1ea6U CHAT","chatBtnMsgFontColor":"#ffffff","textarea1BackgroundColor":"#ffffff","textarea1PlaceholderColor":"","textarea1FontColor":"#000000","requireAvatar":"0","avatarRadius":"50%","requireName":"1","headerTextM2":"H\u1ed7 tr\u1ee3 tr\u1ef1c tuy\u1ebfn","adminAvatarColor":"","userAvatarColor":"","initMsgModule_2":"Xin ch\u00e0o, ch\u00fang t\u00f4i c\u00f3 th\u1ec3 gi\u00fap g\u00ec cho b\u1ea1n ?","adminNameColor":"#1e8ceb","adminTimeColor":"#1e8ceb","adminMessageColor":"#f4f7f9","adminFontColor":"#666666","userNameColor":"#353f45","userTimeColor":"#e7781c","userMessageColor":"#eb2a1e","userFontColor":"#ffffff","textarea2BackgroundColor":"#ffffff","textarea2PlaceholderColor":"","textarea2FontColor":"#000000","textarea2BtnColor":"","userAvatarSelectChoice":"fixed","headerImageType":"operator","headerTextM3":"G\u1eedi ch\u00fang t\u00f4i tin nh\u1eafn","textarea3BackgroundColor":"#ffffff","textarea3PlaceholderColor":"#000000","textarea3FontColor":"#000000","sendMailBtnBackgroundColor":"#eb2a1e","sendMailBtnBackgroundGradient":"","sendMailBtn":"G\u1eecI TIN NH\u1eaeN","sendMailBtnFontColor":"#ffffff","widgetLogoFile":"http:\/\/mitek.local\/\/data\/config\/themes\/img\/logos\/Ultimate-Support-Chat-Logo.png","adminAvatarCssContent":"","adminAvatarColorText":"","userAvatarCssContent":"","userAvatarColorText":"","adminMessageAudio":"1","userMessageAudio":"0","m1PlaceholderTextName":"Nh\u1eadp t\u00ean c\u1ee7a b\u1ea1n","m1PlaceholderTextEmail":"Nh\u1eadp email c\u1ee7a b\u1ea1n","requireEmail":"0","m2PlaceholderTextMessage":"Nh\u1eadp n\u1ed9i dung v\u00e0 \u1ea5n Enter \u0111\u1ec3 chat...","m3PlaceholderTextName":"Xin m\u1eddi nh\u1eadp H\u1ecd t\u00ean","m3PlaceholderTextEmail":"Email (\u0111\u1ec3 ch\u00fang t\u00f4i li\u00ean h\u1ec7 v\u1edbi b\u1ea1n)","m3PlaceholderTextMessage":"N\u1ed9i dung tin nh\u1eafn","textarea2EmojiBtnColor":"","requireSupportType":"1","emailOfflineMsg":"phongkinhdoanh@minhtuanmobile.com","audioClient":"1","reviewChat":"0","requirePhone":"1"};
var jsGlobalConfig = {"selectedPreset":"4","admin_desktop_notifications":"true","admin_incoming_chat_request_audio":"true","incoming_chat_audio":"9","track_users":"all","allow_chat_invite":"true","hide_admin":"false","offline_hide":"false","allowedDomains":"all","allowedDommainsList":"","google_maps_api_key":""};
</script>

<link href="./michat.css" type="text/css" rel="stylesheet">
<link href="./font-awesome.css" rel="stylesheet">
<script>
    // var Base64 = (function() {
    //     var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
    //     var obj = {
    //         encode: function(input) {
    //             var output = "";
    //             var chr1, chr2, chr3;
    //             var enc1, enc2, enc3, enc4;
    //             var i = 0;
    //             do {
    //                 chr1 = input.charCodeAt(i++);
    //                 chr2 = input.charCodeAt(i++);
    //                 chr3 = input.charCodeAt(i++);
    //                 enc1 = chr1 >> 2;
    //                 enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
    //                 enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
    //                 enc4 = chr3 & 63;
    //                 if (isNaN(chr2)) {
    //                     enc3 = enc4 = 64;
    //                 } else if (isNaN(chr3)) {
    //                     enc4 = 64;
    //                 }
    //                 output = output + keyStr.charAt(enc1) + keyStr.charAt(enc2) + keyStr.charAt(enc3) + keyStr.charAt(enc4);
    //             } while (i < input.length);
    //             return output;
    //         },
    //         decode: function(input) {
    //             var output = "";
    //             var chr1, chr2, chr3;
    //             var enc1, enc2, enc3, enc4;
    //             var i = 0;
    //             input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");
    //             do {
    //                 enc1 = keyStr.indexOf(input.charAt(i++));
    //                 enc2 = keyStr.indexOf(input.charAt(i++));
    //                 enc3 = keyStr.indexOf(input.charAt(i++));
    //                 enc4 = keyStr.indexOf(input.charAt(i++));
    //                 chr1 = (enc1 << 2) | (enc2 >> 4);
    //                 chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
    //                 chr3 = ((enc3 & 3) << 6) | enc4;
    //                 output = output + String.fromCharCode(chr1);
    //                 if (enc3 != 64) {
    //                     output = output + String.fromCharCode(chr2);
    //                 }
    //                 if (enc4 != 64) {
    //                     output = output + String.fromCharCode(chr3);
    //                 }
    //             } while (i < input.length);
    //             return output;
    //         }
    //     };
    //     return obj;
    // })();
    var mi_group = '103';
    var Gab = {
        connection: null,
        start_time: null,
        log: function(msg) {
            // console.log(msg);
        },
        jid_to_id: function(jid) {
            return Strophe.getBareJidFromJid(jid).replace(/@/g, "-").replace(/\./g, "-")
        },
        set_cookies: function() {
            $.cookie('xmpp_jid', Gab.connection.jid, {
                path: '/'
            });
            $.cookie('xmpp_sid', Gab.connection.sid, {
                path: '/'
            });
            $.cookie('xmpp_rid', Gab.connection.rid, {
                path: '/'
            })
        },
        del_cookies: function() {
            $.cookie('xmpp_jid', null);
            $.cookie('xmpp_sid', null);
            $.cookie('xmpp_rid', null)
        },
        listCollections: function(jid, rsm, callback) {
            var xml = $iq({
                type: 'get',
                id: this._connection.getUniqueId('list')
            }).c('list', {
                xmlns: Strophe.NS.ARCHIVE,
                'with': jid,
                'from': fromDate
            })
        },
        on_connect: function(status) {
            if (status === Strophe.Status.REGISTER) {
                Gab.connection.register.fields.username = 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-');
                Gab.connection.register.fields.password = hash;
                Gab.connection.register.fields.name = 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-');
                Gab.connection.register.submit();
                Gab.log(connection.register.fields)
            } else if (status === Strophe.Status.REGISTERED) {
                Gab.log("registered!" + status);
                Gab.connection.register.authenticate()
            } else if (status === Strophe.Status.CONFLICT) {
                Gab.log("Contact already existed!" + status)
            } else if (status === Strophe.Status.NOTACCEPTABLE) {
                Gab.log("Registration form not properly filled out." + status)
            } else if (status === Strophe.Status.REGIFAIL) {
                Gab.log("The Server does not support In-Band Registration" + status)
            } else if (status === Strophe.Status.CONNECTING) {
                Gab.log('Strophe is connecting.' + status)
            } else if (status === Strophe.Status.CONNFAIL) {
                Gab.log('Strophe failed to connect.' + status)
            } else if (status === Strophe.Status.AUTHENTICATING) {
                Gab.log('Strophe is authenticating.' + status)
            } else if (status === Strophe.Status.DISCONNECTING) {
                Gab.log('Strophe is disconnecting.' + status)
            } else if (status === Strophe.Status.DISCONNECTED) {
                Gab.log('Strophe is disconnected.' + status);
                //markup()
                //chatInit(sessionStorage.getItem("michat_support-jsSession--user_name"), sessionStorage.getItem("michat_support-jsSession--request_id"));
                $(document).trigger('connect')
            } else if (status === Strophe.Status.CONNECTED) {
                Gab.log('Strophe is connected.' + status);
                $(document).trigger('connected', {
                    status: 'connected'
                })
            } else if (status === Strophe.Status.ATTACHED) {
                Gab.log('Strophe is attached.' + status);
                $(document).trigger('connected', {
                    status: 'attach'
                })
            }
        },
        send_ping: function(to) {
            var ping = $iq({
                to: to,
                type: "get",
                id: "ping1"
            }).c("ping", {
                xmlns: "urn:xmpp:ping"
            });
            Gab.start_time = (new Date()).getTime();
            Gab.connection.send(ping)
        },
        handle_pong: function(iq) {
            var elapsed = (new Date()).getTime() - Gab.start_time
        },
        on_roster: function(iq) {
            $(iq).find('item').each(function() {
                var jid = $(this).attr('jid');
                var name = $(this).attr('name') || jid;
                var jid_id = Gab.jid_to_id(jid);
                var contact = $("<li id='" + jid_id + "'>" + "<div class='roster-contact offline'>" + "<div class='roster-name'>" + name + "</div><div class='roster-jid'>" + jid + "</div></div></li>");
                Gab.insert_contact(contact)
            });
            Gab.connection.addHandler(Gab.on_presence, null, "presence");
            Gab.connection.send($pres())
        },
        pending_subscriber: null,
        on_presence: function(presence) {
            var ptype = $(presence).attr('type');
            var from = $(presence).attr('from').split('/')[0];
            var jid_id = Gab.jid_to_id(from);
            if (ptype === 'subscribe') {
                Gab.pending_subscriber = from;
                $('#approve-jid').text(Strophe.getBareJidFromJid(from));
                $('#approve_dialog').dialog('open')
            } else if (ptype !== 'error') {
                var contact = $('#roster-area li#' + jid_id + ' .roster-contact').removeClass("online").removeClass("away").removeClass("offline");
                if (ptype === 'unavailable') {
                    contact.addClass("offline")
                } else {
                    var show = $(presence).find("show").text();
                    if (show === "" || show === "chat") {
                        contact.addClass("online")
                    } else {
                        contact.addClass("away")
                    }
                }
                var li = contact.parent();
                li.remove();
                Gab.insert_contact(li)
            }
            if (ptype === 'unavailable') {} else {}
            var jid_id = Gab.jid_to_id(from);
            $('#chat-' + jid_id).data('jid', Strophe.getBareJidFromJid(from));
            return !0
        },
        on_roster_changed: function(iq) {
            $(iq).find('item').each(function() {
                var sub = $(this).attr('subscription');
                var jid = $(this).attr('jid');
                var name = $(this).attr('name') || jid;
                var jid_id = Gab.jid_to_id(jid);
                if (sub === 'remove') {
                    $('#' + jid_id).remove()
                } else {
                    var contact_html = "<li id='" + jid_id + "'>" + "<div class='" + ($('#' + jid_id).attr('class') || "roster-contact offline") + "'>" + "<div class='roster-name'>" + name + "</div><div class='roster-jid'>" + jid + "</div></div></li>";
                    if ($('#' + jid_id).length > 0) {
                        $('#' + jid_id).replaceWith(contact_html)
                    } else {
                        Gab.insert_contact($(contact_html))
                    }
                }
            });
            return !0
        },
        on_message: function(message) {
            var full_jid = $(message).attr('from');
            var jid = Strophe.getBareJidFromJid(full_jid);
            var jid_id = Gab.jid_to_id(jid);
            $.ajax({
                url: 'https://demo-2021.midesk.vn/chat/agentDetails',
                type: "POST",
                dataType: 'json',
                data: {
                    'YWdlbnRfZGV0YWlsc192NA==': 'agent_details_v4',
                    'amlk': jid,
                },
                success: function(data) {
                    if (data[1] != '') {
                        user_pic = data[1]
                    } else {
                        user_pic = 'no_user_photo-v1.jpg'
                    }
                    var michat_header = '';
                    michat_header += '<table width="100%" style="font-size:14px;color:#fff;">\
                        <tr>\
                            <td id="click_back" width="10px"><img style="width:12px" src="https://demo-2021.midesk.vn/public/webchat/images/arrow.png"></td>\
                            <td width="10px" style="text-align:center;">\
                                <div>\
                                    <img id="agent-avatar-header" src="' + dataAvatarAgent + user_pic + '">\
                                </div>\
                                <div id="online_icon"></div>\
                                <div style="margin-top:-6px;"></div>\
                            </td>\
                            <td width="100px">\
                                <div id="agent-title" data-id="' + data[2] + '"><span>' + data[0] + '</span>';
                    if (jsThemeConfig.reviewChat == '1') {
                        michat_header += '<span style="float:right;padding-right:22px;"><span id="like_chat" style="cursor:pointer;padding: 5px;"><i class="fa fa-thumbs-o-up"></i></span><span id="unlike_chat" style="cursor:pointer;padding: 5px;"><i class="fa fa-thumbs-o-up" style="transform: rotate(180deg);"></i></span></span>'
                    }
                    michat_header += '</div>';
                    michat_header += '<div id="status-agent-title">Nhân viên tư vấn</div></td>';
                    michat_header += '<td width="10px">\
                                    <span id="click_down" title="Thu nhỏ chat" class="michat_options_btn" style="font-size: 10px; display: inline;"><i class="fa fa-window-minimize"></i></span>\
                                </td>';
                    michat_header += '</tr>\
                    </table>';
                    $('#michat_header').html(michat_header);
                    name_visitor = data[0];
                    if ($('#chat-' + jid_id).length === 0) {
                        $('#chat-' + jid_id).append("<div class='chat-messages'></div>" + "<input type='text' class='chat-input' placeholder='Type a message...' style='font-size: 12px;width:236px;'>")
                    }
                    $('#chat-' + jid_id).data('jid', full_jid);
                    $('#chat-' + jid_id + ' input').focus();
                    var composing = $(message).find('composing');
                    if (composing.length > 0) {
                        if ($('.chat-event').length > 0) {
                            $('.chat-event').remove()
                        }
                        $('#chat-' + jid_id + ' .chat-messages').append("<div class='chat-event'>" + "Agent is typing...</div>");
                        if ($('#chat_history .typing-indicator').length == 0) {
                            $('#chat_history').append('<div class="typing-indicator"><span></span><span></span><span></span></div>')
                        }
                        Gab.scroll_chat()
                    }
                    var body = $(message).find("html > body");
                    if (body.length === 0) {
                        body = $(message).find('body');
                        if (body.length > 0) {
                            body = body.text()
                        } else {
                            body = null
                        }
                    } else {
                        body = body.contents();
                        var span = $("<span></span>");
                        body.each(function() {
                            if (document.importNode) {
                                $(document.importNode(this, !0)).appendTo(span)
                            } else {
                                span.append(this.xml)
                            }
                        });
                        body = span
                    }
                    if (body) {
                        if (jsThemeConfig.audioClient == 1) {
                            playAudio()
                        }
                        setSlideUpToggle("open");
                        notifyCaseInChrome('[MiChat] Bạn có tin nhắn mới');
                        if (body.indexOf('end chat.') >= 0) {
                            location.reload()
                        } else if (body.indexOf('chuyển chat.') >= 0 && $(message).find('agent').text() != '') {
                            $('#chat_history').append('<div class="a_reply theme2" style="text-align:center;color: #1f8ceb;font-size: 12px;font-style: italic;">' + body + '</div>')
                        } else {
                            if (data[1] != '') {
                                user_pic = data[1]
                            } else {
                                user_pic = 'no_user_photo-v1.jpg'
                            }
                            if ($('#agent-list-div').length) {
                                $('#agent-list-div').remove();
                                $('#usc_wysiwyg').css('display', 'block')
                            }
                            var list_exists = $("#chat_history").find('.a_reply').map(function() {
                                return $(this).attr('id')
                            }).get();
                            if ($.inArray($(message).find('rand').text(), list_exists) == -1) {
                                $('#chat_history').append('<div id="' + $(message).find('rand').text() + '" class="a_reply theme2">\
                                    <div style="color: #aaaaaa;margin-left: 50px;font-size: 11px;font-weight: bold;">' + name_visitor + '</div>\
                                    <span class="a_1 admin_avatar avatar_round" style="background-color: transparent;">\
                                        <img src="' + dataAvatarAgent + user_pic + '">\
                                    </span>\
                                    <span class="a_avatar_border"></span>\
                                    <span class="a_content_wrap" style="background:' + jsThemeConfig.adminMessageColor + '">\
                                        <span class="a_2 admin_name">' + name_visitor + '</span><span class="a_3 admin_time"></span>\
                                        <span class="a_4 admin_msg left_msg_bubble" style="">' + body + '</span>\
                                    </span>\
                                    <div class="" style="color: #aaaaaa;padding-left: 50px;font-size: 11px;">' + dateFormat(new Date(), "dd/mm/yy hh:MM TT") + '</div>\
                                </div>')
                            }
                        }
                        $('#chat-' + jid_id + ' .chat-event').remove();
                        $('.typing-indicator').remove();
                        $('#chat-' + jid_id + ' .chat-message:last .chat-text').append(body);
                        Gab.scroll_chat()
                    }
                }
            });
            return !0
        },
        scroll_chat: function() {
            var div = $('#chat_history').get(0);
            div.scrollTop = div.scrollHeight
        },
        presence_value: function(elem) {
            if (elem.hasClass('online')) {
                return 2
            } else if (elem.hasClass('away')) {
                return 1
            }
            return 0
        },
        insert_contact: function(elem) {
            var jid = elem.find('.roster-jid').text();
            var pres = Gab.presence_value(elem.find('.roster-contact'));
            var contacts = $('#roster-area li');
            if (contacts.length > 0) {
                var inserted = !1;
                contacts.each(function() {
                    var cmp_pres = Gab.presence_value($(this).find('.roster-contact'));
                    var cmp_jid = $(this).find('.roster-jid').text();
                    if (pres > cmp_pres) {
                        $(this).before(elem);
                        inserted = !0;
                        return !1
                    } else if (pres === cmp_pres) {
                        if (jid < cmp_jid) {
                            $(this).before(elem);
                            inserted = !0;
                            return !1
                        }
                    }
                });
                if (!inserted) {
                    $('#roster-area ul').append(elem)
                }
            } else {
                $('#roster-area ul').append(elem)
            }
        }
    };

    function playAudio() {
        var audioElement = document.createElement('audio');
        audioElement.setAttribute('src', 'https://demo-2021.midesk.vn/public/sounds/notification-2.ogg');
        audioElement.setAttribute('autoplay', 'autoplay');
        audioElement.load()
    }

    function notifyCaseInChrome(channel, numberMsg, message) {
        if(mi_group == 286) return false;  //phukiengiare
        var numberMsg = numberMsg > 1 ? ' (' + numberMsg + ')' : '';
        if (!("Notification" in window)) {
            alert("This browser does not support desktop notification")
        } else if (Notification.permission === "granted") {
            var options = {
                icon: 'https://demo-2021.midesk.vn/public/dist/img/icon/notifi_chat.png',
                body: message,
            };
            var notification = new Notification(channel + numberMsg, options);
            notification.onclick = function() {
                parent.focus();
                this.cancel()
            };
            setTimeout(function() {
                notification.close()
            }, 5000)
        } else if (Notification.permission !== 'denied') {
            Notification.requestPermission(function(permission) {
                if (!('permission' in Notification)) {
                    Notification.permission = permission
                }
                if (permission === "granted") {
                    var options = {
                        icon: 'https://demo-2021.midesk.vn/public/dist/img/icon/notifi_chat.png',
                        body: message,
                    };
                    var notification = new Notification(channel + numberMsg, options);
                    notification.onclick = function() {
                        parent.focus();
                        this.cancel()
                    };
                    setTimeout(function() {
                        notification.close()
                    }, 5000)
                }
            })
        }
    }
</script>
<script src="./jquery-2.1.4.min.js.tải xuống"></script>
<script src="./server.js.tải xuống"></script>
<!--<script src='https://demo-2021.midesk.vn/public/webchat/scripts/strophe-1.2.14.js'></script>-->
<!--<script src='https://demo-2021.midesk.vn/public/webchat/scripts/websocket.js'></script>-->
<script src="./server.register.js.tải xuống"></script>
<script src="./jquery.cookie.js.tải xuống"></script><script src="./socket.io.min.js.tải xuống"></script>
<script>
    var baseurl = 'https://livechat-2021.midesk.vn/',timesReconnect = 1;
    // var baseurl = 'https://nodelivechat-prod.midesk.vn',timesReconnect = 1;
    // var socket = io(baseurl);
    var socket = io.connect(baseurl, {
       "transports": ['websocket']
    })
    // console.log(socket);
    var link_xmpp = 'https://xmpp.midesk.vn/http-bind/';
    var domain_xmpp = 'michat.vn';
    var hostname_xmpp = 'xmpp.michat.vn';
</script>
<script src="./client_socket.js.tải xuống"></script>



<!-- <div id="googleTag"></div> -->

    <!-- Google Tag Manager -->
    <!-- <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-W2FB9VC');</script> -->
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-42777526-4"></script> -->
    <!-- <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-42777526-4');
    </script> -->

</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <!-- <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W2FB9VC"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> -->
    <!-- End Google Tag Manager (noscript) -->
    <div id="michat_wrap" class=""><div class="michat_holder" id="michat_holder" style="box-shadow: rgb(0, 0, 0) 0px 5px 35px -10px; border-top-left-radius: 0px; border-top-right-radius: 0px; background: rgb(252, 252, 252); display: none;" data-module="3"><div class="michat_header" id="michat_header" style="background-color:#eb2a1e;"><span class="header_text" style="color:#fff">Gửi chúng tôi tin nhắn</span><span class="michat_close_holder" id="michat_close_holder" style="display:none;color:#fff"><icon class="default_chaticon_s" data-icon="b"></icon></span></div><form id="send_msg_m3" method="post" style="height: 79%;overflow-y: auto;">                <div style="margin-right: 38px;margin-left: 38px;padding-bottom: 5px;margin-top: 22px;">                    <label style="font-size: 12px; font-weight: bold;color: #666666">Hiện giờ chúng tôi không ở đây, xin vui lòng để lại lời nhắn.</label>                </div>                <input type="text" class="michat_input" name="contact_name" id="contact_name" placeholder="Xin mời nhập Họ tên" required="" style="background: rgb(255, 255, 255); color: rgb(0, 0, 0);"><input type="text" class="michat_input" name="contact_phone" id="contact_phone" onkeypress="return event.charCode &gt;= 48 &amp;&amp; event.charCode &lt;= 57" maxlength="11" placeholder="Số điện thoại" required=""><div>                    <label style="margin-left: 40px;font-size: 12px; font-weight: bold;color: #666666">Hãy gửi tin nhắn cho chúng tôi về vấn đề của bạn :</label>                </div>                <textarea class="michat_textarea" name="contact_message" id="contact_message" placeholder="Nội dung tin nhắn" style="resize: none; height: 80px !important; background: rgb(255, 255, 255); color: rgb(0, 0, 0);" required=""></textarea>                <input type="submit" id="michat_button_offline" class="michat_button" value="GỬI TIN NHẮN" style="background:#eb2a1e; color:#ffffff">            </form>            <div id="michat_bottom_textarea_wrapper" style="bottom:0px;background-color: #ffffff;border-bottom-left-radius: 8px;border-bottom-right-radius: 8px;">                <div style="height:100%;background-color:#fbfbfc;"></div>                <div id="footer-company"><label id="lbl-company"><a href="https://midesk.vn/" target="_blank" style="text-decoration: none;color: #1e8bea;">MiDesk</a>, a product of <a href="https://mitek.vn/?utm_source=minhtuanmobile_com&amp;utm_medium=widget&amp;utm_campaign=widget_referral" target="_blank" style="text-decoration: none;color: #1e8bea;">MITEK</a></label></div>            </div>        </div>    <div class="michat_btn_wrap" id="michat_btn_wrap" style="display: block;"><div class="michat_start_btn" id="michat_start_btn" style="background: rgb(235, 42, 30); display: block;"></div><div class="michat_close_btn " id="michat_close_btn" style="background: rgb(235, 42, 30); display: none;"></div></div></div>

<div id="load-page_2" style="display: none;"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div>
<style>
    #load-page_2,
    #load-page_2_in {
        left: 0;
        top: 0;
        color: black;
        background: rgba(112, 112, 112, 0.02);
        right: 0;
        bottom: 0;
        text-align: center;
        padding-top: 45%;
        opacity: .4
    }
</style>
<script>
    var encodedGetVars = 'eyJncm91cCI6IjEwMyIsInRpdGxlX3dlYiI6IlNlYXJjaDogaXBob25lIDE1IC0gTWluaCBUdeG6pW4gTW9iaWxlIiwibGlua19wb3J0YWwiOiJodHRwczovL2RlbW8tMjAyMS5taWRlc2sudm4vc3VwcG9ydGNoYXQvd2lkZ2V0IiwiaG9zdF9uYW1lIjoibWluaHR1YW5tb2JpbGUuY29tIiwiY3VycmVudF91cmwiOiJodHRwczovL21pbmh0dWFubW9iaWxlLmNvbS9zZWFyY2gvP2s9aXBob25lKzE1IiwicmVmX3VybCI6Imh0dHBzOi8vbWluaHR1YW5tb2JpbGUuY29tL21hY2Jvb2stYWlyLW0yLTEzLTYtaW5jaC0yMDIyLWNoaXAtbTItOGNwdS0xMGdwdS01MTJnYi1yYW0tOGdiLyIsIm9zIjoiV2luZG93cyAxMCIsImJyb3dzZXIiOiJDaHJvbWUgMTE1ICgxMTUuMC4wLjApIiwibW9iaWxlIjpmYWxzZSwic2NyZWVuX3NpemUiOiIxMjgwIHggNzIwIiwiaXBfYWRkcmVzcyI6IjEwLjEwLjEwMy4yNTAiLCJjb29raWVzIjp0cnVlLCJjb29raWVfd2lkZ2V0IjoiZGQ1MTlhOTctYWIwMi00NDlkLTkzZGQtMzRjYTkzYmRlYWFjIiwibGFuZyI6InZpIiwiaGFzaCI6Ik1USXpORFUyIiwib3JpZ2luIjoiaHR0cHM6Ly9taW5odHVhbm1vYmlsZS5jb206In0=';
    var jsGetVars = JSON.parse('{"group":"103","title_web":"Search: iphone 15 - Minh Tu\u1ea5n Mobile","link_portal":"https:\/\/demo-2021.midesk.vn\/supportchat\/widget","host_name":"minhtuanmobile.com","current_url":"https:\/\/minhtuanmobile.com\/search\/?k=iphone+15","ref_url":"https:\/\/minhtuanmobile.com\/macbook-air-m2-13-6-inch-2022-chip-m2-8cpu-10gpu-512gb-ram-8gb\/","os":"Windows 10","browser":"Chrome 115 (115.0.0.0)","mobile":false,"screen_size":"1280 x 720","ip_address":"10.10.103.250","cookies":true,"cookie_widget":"dd519a97-ab02-449d-93dd-34ca93bdeaac","lang":"vi","hash":"MTIzNDU2","origin":"https:\/\/minhtuanmobile.com:"}');
    var target_origin;
    var appDir = 'https://demo-2021.midesk.vn/supportchat';
    var dataServer = appDir + '/data/';
    var dataAvatarAgent = 'https://demo-2021.midesk.vn/upload/images/userthumb/';
    var trackPages = 'all';
    var allowInvite = 'true';
    var wysiwygNode = '';
    var emojiFamily = 'twitter';
    var mi_group = jsGetVars.group;
    var hash = Base64.decode(jsGetVars.hash);
    var operatorsOnline = checkOperator2();
    var request_id;
    var _invite_chat_flag;
    var _start_chat_flag;
    var _agent_invite_flag;
    var _message_archive;
    var _user_online_arr = [];

    if(mi_group == 88){  // Vinbus
        window.location.href = 'https://demo-2021.midesk.vn/';
    }
 //    window.myFunction = function(args) {
 //   		console.log('window test');
	// }
	// window.addEventListener('message', receiver, false);
	// function receiver(e) {
	// 	console.log(e.data);
	//   	// if (e.origin == 'http://localhost') {
	//    //  	if (e.data == 'Hello world') {
	//    //    		e.source.postMessage('Hello', e.origin);
	//    //  	} else {
	//    //    		alert(e.data);
	//    //  	}
	//   	// }
	// }

    var watermark_html = '<label id="lbl-company"><a href="https://midesk.vn/" target="_blank" style="text-decoration: none;color: #1e8bea;">MiDesk</a>, a product of <a href="https://mitek.vn/?utm_source=' + jsGetVars.host_name.replace(".", "_") + '&utm_medium=widget&utm_campaign=widget_referral" target="_blank" style="text-decoration: none;color: #1e8bea;">MITEK</a></label>';
    // $.ajax({
    //     url: 'https://demo-2021.midesk.vn/chat/getLanguage',
    //     type: "POST",
    //     async: !1,
    //     data: {
    //         'groupid': mi_group,
    //     },
    //     success: function(data) {
    //         data = JSON.parse(data);
    //         if(data.enable_watermark == 1){
    //             watermark_html = '<label id="lbl-company"><a href="https://midesk.vn/" target="_blank" style="text-decoration: none;color: #1e8bea;">MiDesk</a>, a product of <a href="https://mitek.vn/?utm_source=' + jsGetVars.host_name.replace(".", "_") + '&utm_medium=widget&utm_campaign=widget_referral" target="_blank" style="text-decoration: none;color: #1e8bea;">MITEK</a></label>';
    //         }
    //         // console.log(data.en_chat_btn_msg);
    //     }
    // });
    
    // console.log(checkOperator2());
    function validateName(str){
        if(str.includes("<") || str.includes(">")){
            return false;
        }
        return true;
    }

    function validateEmail(e) {
        var F = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return F.test(e)
    }

    function nl2br(str, is_xhtml) {
        var breakTag = (is_xhtml || typeof is_xhtml === 'undefined') ? '<br />' : '<br>';
        return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1' + breakTag + '$2')
    }

    function encodeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML
    }

    function linkify(str) {
        if(str.indexOf('href')==-1){
            var newStr = str.replace(/(<a href=")?((https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)))(">(.*)<\/a>)?/gi, function() {
                return '<a href="' + arguments[2] + '" target="_blank">' + (arguments[7] || arguments[2]) + '</a>'
            });
            return (newStr);
        }else{
            return str;
        }
        
    }

    function getDateToday() {
        var x = new Date,
            e = x.getDate(),
            t = x.getMonth() + 1,
            n = x.getFullYear();
        return 10 > e && (e = "0" + e), 10 > t && (t = "0" + t), x = t + "/" + e + "/" + n
    }

    function generateJsUniqueID() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(x) {
            var e = 16 * Math.random() | 0,
                t = "x" == x ? e : 3 & e | 8;
            return t.toString(16)
        })
    }

    function checkOperator2() {
        var user;
        $.ajax({
            url: 'https://demo-2021.midesk.vn/chat/checkOperator',
            type: "POST",
            async: !1,
            data: {
                'groupid': mi_group,
                'id_chat': 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-'),
                'host_name': jsGetVars.host_name,
                'url_visit': jsGetVars.current_url,
                'date': new Date().getDate(),
            },
            success: function(data) {
                user = data
            }
        });
        return user
    }
    // socket.emit('test chat', {
    //     groupid: mi_group
    // });

    function initTracker2() {
        $.ajax({
            url: 'https://demo-2021.midesk.vn/chat/initTracker2',
            type: "POST",
            dataType: 'json',
            async: !1,
            data: {
                'jsCookie': localStorage.getItem("michat_support-jsCookie"),
                'encodedGetVars': encodedGetVars,
                'track_page': trackPages,
            },
            success: function(data) {
                if (data != '') {
                    var a = generateJsUniqueID();
                    sessionStorage.setItem("michat_support-jsSession", a);
                    sessionStorage.setItem("michat_support-jsSession--user_id", data.user_id);
                    sessionStorage.setItem("michat_support-jsSession--ip_address", jsGetVars.ip_address);
                    sessionStorage.setItem("michat_support-jsSession--country_name", data.country_name);
                    sessionStorage.setItem("michat_support-jsSession--country_code", data.country_code);
                    sessionStorage.setItem("michat_support-jsSession--longitude", data.longitude);
                    sessionStorage.setItem("michat_support-jsSession--latitude", data.latitude)
                }
            }
        })
    }

    function trackerPing2() {
        $.ajax({
            url: 'https://demo-2021.midesk.vn/chat/trackerPing',
            type: "POST",
            dataType: 'json',
            data: {
                'jsCookie': localStorage.getItem("michat_support-jsCookie"),
                'encodedGetVars': encodedGetVars,
                'track_page': trackPages,
            },
            success: function(data) {
                console.log(data)
            }
        })
    }

    function getMonitor() {
        return false;
        $.ajax({
            url: 'https://demo-2021.midesk.vn/chat/getMonitor',
            type: "POST",
            dataType: 'json',
            async: !1,
            data: {
                'visitor_jid': 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-'),
                'groupid': mi_group,
                'cookie_id': localStorage.getItem("michat_support-jsCookie"),
                'host_name': jsGetVars.host_name,
            },
            success: function(data) {
                // console.log(data);
                // socket.emit('ONLINE_VISITORS', {
                //     groupid: mi_group,
                //     name: 'Guest',
                //     cookie_id: localStorage.getItem("michat_support-jsCookie"),
                //     session_id: sessionStorage.getItem("michat_support-jsSession"),
                //     os: jsGetVars.os,
                //     browser: jsGetVars.browser,
                //     browser_lang: jsGetVars.lang,
                //     mobile: jsGetVars.mobile,
                //     screen_size: jsGetVars.screen_size,
                //     ip_address: sessionStorage.getItem("michat_support-jsSession--ip_address"),
                //     country_name: sessionStorage.getItem("michat_support-jsSession--country_name"),
                //     country_code: sessionStorage.getItem("michat_support-jsSession--country_code"),
                //     link_portal: jsGetVars.current_url,
                //     host_name: jsGetVars.host_name,
                //     link_widget: window.location.hostname,
                //     date_chat: getDateToday(),
                //     visitor_jid: 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-'),
                //     'name_visit': data.name_visit,
                //     'sess': data.sess,
                //     'assign': data.assign,
                //     'assign_id': data.assign_id,
                //     'is_queue': data.is_queue,
                //     'location': data.location,
                //     'num_mess': data.num_mess,
                //     'online': data.online,
                //     'first_reply_time': data.first_reply_time,
                //     'date_visit': data.date_visit,
                //     'src_url': data.src_url,
                //     'ref_url': data.ref_url,
                // })
            }
        })
    }

    function getBrowserNoVersion(e) {
        return -1 === e.indexOf(" ") ? e : e.substr(0, e.indexOf(" "))
    }

    function chatInit(e, t) {
        function s(e, t) {
            var s = (document.getElementById("user_ui").value, new XMLHttpRequest);
            s.onreadystatechange = function() {
                if (4 == s.readyState && 200 == s.status) {
                    if (null == s.responseText) return;
                    var e = JSON.parse(s.responseText),
                        o = "";
                    "1" == e.operator_typing && "open" == slideToggleState && (o = '<div id="op_is_typing" class="is_typing">Operator is typing...</div>'), "dynamic" == jsThemeConfig.userAvatarCssContentStyle && (jsThemeConfig.userAvatarCssContent = e.user_name.charAt(0).toUpperCase()), a = e.rows.length;
                    var r = "",
                        i = "";
                    for (var n in e.rows) e.rows.hasOwnProperty(n) && (i += e.rows[n], r = n);
                    if (1 == t && sessionStorage.setItem("michat_support-jsSession--userLogResults", a), a > sessionStorage.getItem("michat_support-jsSession--userLogResults") && (sessionStorage.setItem("michat_support-jsSession--userLogResults", a), 0 != e.operator_id[r] && "off" != sessionStorage.getItem("michat_support-jsSession--widget_soundNotification"))) {
                        var g = "0";
                        void 0 != jsThemeConfig.userMessageAudio && (g = jsThemeConfig.userMessageAudio);
                        var d = new Audio(dataServer + "/audio/" + g + ".mp3");
                        d.play()
                    }
                    var m = '<div class="last_row_spacer">&nbsp;</div>';
                    document.getElementById("chat_history").innerHTML = i + m + o;
                    var _ = "</terminate>";
                    if (i.indexOf(_) > -1 == 1 && document.getElementById("end_chat_btn").click(), sessionStorage.setItem("michat_support-jsSession--operator_avatar", JSON.stringify(e.operator_avatar)), "operator" == jsThemeConfig.headerImageType && "undefined" != sessionStorage.getItem("michat_support-jsSession--operator_avatar") && void 0 != sessionStorage.getItem("michat_support-jsSession--operator_avatar")) {
                        var u = JSON.parse(sessionStorage.getItem("michat_support-jsSession--operator_avatar"));
                        u && ("" != u[0] ? document.getElementById("header_image").innerHTML = '<img src="' + dataAvatarAgent + u[0] + '"/>' : document.getElementById("header_image").innerHTML = '<img src="' + dataServer + 'config/themes/img/avatars/admin_avt.jpg"/>')
                    }
                    buildLayout(), "manual" != sessionStorage.getItem("michat_support-jsSession--widget_scroll_type") && e.rows.length > sessionStorage.getItem("michat_support-jsSession--widget_chat_length") && (sessionStorage.setItem("michat_support-jsSession--widget_chat_length", e.rows.length), document.getElementById("chat_history").scrollTop = document.getElementById("chat_history").scrollHeight)
                }
            }
        }
        window.addEventListener && ("slideside" == jsThemeConfig.triggerMethod ? parent.postMessage({
            task: "iframe_resize_" + jsThemeConfig.triggerMethod
        }, target_origin) : parent.postMessage({
            task: "iframe_init_default"
        }, target_origin)), document.getElementById("michat_wrap").innerHTML = chatMarkup;
        document.getElementById("usc_emoji_picker");
        setSlideUpToggle("closed"), "wide" == sessionStorage.getItem("michat_support-jsSession--widgetWidthMode") && (removeClass("a_avatar_border", "a_avatar_border_wide"), removeClass("a_content_wrap", "content_wrap_wide"), removeClass("admin_msg", "admin_msg_wide"), removeClass("u_avatar_border", "u_avatar_border_wide"), removeClass("u_content_wrap", "content_wrap_wide"), removeClass("user_msg", "user_msg_wide"), wideMode()), null !== sessionStorage.getItem("michat_support-jsSession--post_started") && (s(t, !0), setInterval(function() {
            s(t)
        }, 5e3)), "default" == jsThemeConfig.triggerMethod && void 0 != document.getElementById("michat_start_btn") && (document.getElementById("michat_start_btn").onclick = function() {
            setSlideUpToggle("open")
        }), document.getElementById("user_ui").value = encodedGetVars;
        var o = 0,
            a = ""
    }

    function messageInit() {
        document.getElementById("michat_wrap").innerHTML = message_init, buildLayout(!0), setSlideUpToggle("closed")
    }

    function markup() {
        document.getElementById("michat_wrap").innerHTML = mark_up, buildLayout(!0), setSlideUpToggle("closed")
    }

    function onbeforeunload() {
        sessionStorage.setItem("michat_support-jsSession--page_before_refresh", sessionStorage.getItem("michat_support-current_url"))
    }

    function createClass(e, t) {
        var a = document.createElement("style");
        a.type = "text/css", document.getElementsByTagName("head")[0].appendChild(a), (a.sheet || {}).insertRule ? a.sheet.insertRule(e + "{" + t + "}", 0) : (a.styleSheet || a.sheet).addRule(e, t)
    }

    function addClass(e, t) {
        for (var a = document.getElementsByClassName(e), o = 0, s = a.length; s > o; o++) a[o].className += " " + t
    }

    function removeClass(e, t) {
        for (var a = document.getElementsByClassName(e), o = 0, s = a.length; s > o; o++) a[o].className = a[o].className.replace(t, "")
    }

    function modifyClass(e, t, a) {
        var o, s = document.getElementsByClassName(e);
        for (o = 0; o < s.length; o++) s[o].setAttribute("style", t + ": " + a + ";")
    }

    function setStyleRule(e, t) {
        var a = document.styleSheets[document.styleSheets.length - 1];
        for (var o in document.styleSheets)
            if (document.styleSheets.hasOwnProperty(o) && document.styleSheets[o].href && document.styleSheets[o].href.indexOf("michat.css")) {
                a = document.styleSheets[o];
                break
            }
        a.addRule ? a.addRule(e, t) : a.insertRule && a.insertRule(e + " { " + t + " }", a.cssRules.length)
    }

    function appendClassContent(e, t) {
        for (var a = document.getElementsByClassName(e), o = 0, s = a.length; s > o; o++) a[o].innerHTML = t
    }

    function buildLayout(e) {
        var t = document.getElementById("michat_holder").getAttribute("data-module");
        if ("slideside" == jsThemeConfig.triggerMethod && 2 != t && (document.getElementById("michat_header_text").style.marginTop = "-55px"), 1 == e) {
            if ("image" == jsThemeConfig.backgroundStyle) {
                addClass("michat_holder", "michat_holder_bg_img");
                var a = jsThemeConfig.widgetBackgroundFile;
                modifyClass("michat_holder_bg_img", "background", "url(" + a + ") repeat center;"), modifyClass("default_chat_history", "background", "transparent")
            }
            if ("image" == jsThemeConfig.headerStyle) {
                "slideside" == jsThemeConfig.triggerMethod ? addClass(" michat_link_holder_slideside", "michat_header_bg_img") : addClass("michat_header", "michat_header_bg_img");
                var o = jsThemeConfig.widgetHeaderFile,
                    s = "";
                "slideside" == jsThemeConfig.triggerMethod && (s = "border-top-left-radius: " + jsThemeConfig.widgetRadius + "; border-top-right-radius: " + jsThemeConfig.widgetRadius + "; border-bottom-left-radius: " + jsThemeConfig.widgetRadius), modifyClass("michat_header_bg_img", "background", "url(" + o + ") repeat left;" + s)
            }
            2 == t && "none" != jsThemeConfig.headerImageType && (addClass("michat_header", "header_tall"), addClass("michat_link_holder_slideside", "header_tall"), addClass("michat_options_li", "options_tall"), void 0 != document.getElementById("header_subtext") && (document.getElementById("header_subtext").style.position = "relative"), void 0 != document.getElementById("header_image") && "logo" == jsThemeConfig.headerImageType && (document.getElementById("header_image").innerHTML = '<img src="' + jsThemeConfig.widgetLogoFile + '"/>'), addClass(jsThemeConfig.triggerMethod + "_chat_history_holder", jsThemeConfig.triggerMethod + "_chat_history_holder_low"), addClass(jsThemeConfig.triggerMethod + "_chat_history", jsThemeConfig.triggerMethod + "_chat_history_low")), "slideside" != jsThemeConfig.triggerMethod && "20px" == jsThemeConfig.widgetRadius && (document.getElementById("michat_header").style.borderTopLeftRadius = "20px", document.getElementById("michat_header").style.borderTopRightRadius = "20px");
            var r = document.getElementById("username"),
                l = document.getElementById("useremail");
            null != r && (r.style.background = jsThemeConfig.textarea1BackgroundColor), null != l && (l.style.background = jsThemeConfig.textarea1BackgroundColor), "Microsoft" != browser && "Microsoft Internet Explorer" != browser ? (null != r && (r.style.color = jsThemeConfig.textarea1FontColor), null != l && (l.style.color = jsThemeConfig.textarea1FontColor)) : setStyleRule(".michat_input_m1", "color:" + jsThemeConfig.textarea1FontColor), jsThemeConfig.textarea1PlaceholderColor && (("Chrome" == browser || "Safari" == browser || "Opera" == browser) && setStyleRule(".michat_input_m1::-webkit-input-placeholder", "color:" + jsThemeConfig.textarea1PlaceholderColor), "Firefox" == browser && (setStyleRule(".michat_input_m1:-moz-placeholder", "opacity:1; color:" + jsThemeConfig.textarea1PlaceholderColor), setStyleRule(".michat_input_m1::-moz-placeholder", "opacity:1; color:" + jsThemeConfig.textarea1PlaceholderColor)), ("Microsoft" == browser || "Microsoft Internet Explorer" == browser) && setStyleRule(".michat_input_m1:-ms-input-placeholder", "color:" + jsThemeConfig.textarea1PlaceholderColor)), setStyleRule(".michat_bottom_textarea", "color:" + jsThemeConfig.textarea2FontColor), jsThemeConfig.textarea2PlaceholderColor && setStyleRule("#usc_wysiwyg:empty:before", "content: attr(placeholder);display: block; color:" + jsThemeConfig.textarea2PlaceholderColor);
            var n = document.getElementById("contact_name"),
                i = document.getElementById("contact_email"),
                m = document.getElementById("contact_message");
            null != n && (n.style.background = jsThemeConfig.textarea3BackgroundColor), null != i && (i.style.background = jsThemeConfig.textarea3BackgroundColor), null != m && (m.style.background = jsThemeConfig.textarea3BackgroundColor), "Microsoft" != browser && "Microsoft Internet Explorer" != browser ? (null != n && (n.style.color = jsThemeConfig.textarea3FontColor), null != i && (i.style.color = jsThemeConfig.textarea3FontColor), null != m && (m.style.color = jsThemeConfig.textarea3FontColor)) : setStyleRule(".michat_input", "color:" + jsThemeConfig.textarea3FontColor), jsThemeConfig.textarea3PlaceholderColor && (("Chrome" == browser || "Safari" == browser || "Opera" == browser) && setStyleRule(".michat_input::-webkit-input-placeholder", "color:" + jsThemeConfig.textarea3PlaceholderColor), "Firefox" == browser && (setStyleRule(".michat_input:-moz-placeholder", "opacity:1; color:" + jsThemeConfig.textarea3PlaceholderColor), setStyleRule(".michat_input::-moz-placeholder", "opacity:1; color:" + jsThemeConfig.textarea3PlaceholderColor)), ("Microsoft" == browser || "Microsoft Internet Explorer" == browser) && setStyleRule(".michat_input:-ms-input-placeholder", "color:" + jsThemeConfig.textarea3PlaceholderColor)), "50%" == jsThemeConfig.avatarRadius && addClass("avatar_li", "avatar_li_round")
        } else {
            if (addClass("a_reply", "theme" + jsThemeConfig.themeSelect), "none" == jsThemeConfig.adminAvatarSelect ? addClass("a_1", "a_no_avatar") : addClass("a_1", "admin_avatar"), 2 == jsThemeConfig.themeSelect && setStyleRule(".right_bubble::after", 'content: ""; position: absolute; border-style: solid;border-width: 6px 0 6px 29px;border-color: transparent ' + jsThemeConfig.adminMessageColor + "; right: -12px; top: 24px;"), addClass("a_content_wrap", "right_bubble"), 5 != jsThemeConfig.themeSelect && modifyClass("a_content_wrap", "background", jsThemeConfig.adminMessageColor), addClass("a_2", "admin_name"), modifyClass("admin_name", "color", jsThemeConfig.adminNameColor), addClass("a_3", "admin_time"), setStyleRule(".admin_time", "color: " + jsThemeConfig.adminTimeColor + " !important"), addClass("a_4", "admin_msg right_msg_bubble"), modifyClass("admin_msg", "background", jsThemeConfig.adminMessageColor), setStyleRule(".admin_msg", "color: " + jsThemeConfig.adminFontColor + " !important"), 2 == jsThemeConfig.themeSelect && "" == jsThemeConfig.adminNameColor && "" == jsThemeConfig.adminTimeColor && modifyClass("admin_msg", "margin", "22px 30% 15px 10px;"), 3 == jsThemeConfig.themeSelect && (modifyClass("a_avatar_border", "background", jsThemeConfig.adminMessageColor), "" == jsThemeConfig.adminNameColor && modifyClass("admin_time", "margin-right", "0px"), "none" == jsThemeConfig.adminAvatarSelect && addClass("a_1", "admin_avatar_ex")), 4 == jsThemeConfig.themeSelect && (setStyleRule(".right_msg_bubble::after", 'content: ""; position: absolute; border-style: solid; border-width: 0 10px 10px; border-color: ' + jsThemeConfig.adminMessageColor + " transparent; display: block; width: 0; z-index: 1; top: -10px; right: 20px;"), "none" == jsThemeConfig.adminAvatarSelect && (addClass("a_2", "admin_name_ex"), addClass("a_3", "admin_time_ex"))), 5 == jsThemeConfig.themeSelect && setStyleRule(".admin_msg::after", 'border-radius: 20px / 10px;content: ""; display: block; position: absolute;border: 8px solid transparent; bottom: 1px; border-bottom-color: ' + jsThemeConfig.adminMessageColor + "; border-radius: 20px / 10px; left: auto;right: -5px;"), "" == jsThemeConfig.adminNameColor && modifyClass("admin_name", "display", "none"), "" == jsThemeConfig.adminTimeColor && modifyClass("admin_time", "display", "none"), addClass("u_reply", "theme" + jsThemeConfig.themeSelect), "none" == jsThemeConfig.userAvatarSelect ? addClass("u_1", "u_no_avatar") : addClass("u_1", "user_avatar"), 2 == jsThemeConfig.themeSelect && setStyleRule(".left_bubble::after", 'content: ""; position: absolute; border-style: solid; border-width: 6px 29px 6px 0; ;border-color: transparent ' + jsThemeConfig.userMessageColor + "; left: -12px; top: 24px;"), addClass("u_content_wrap", "left_bubble"), 5 != jsThemeConfig.themeSelect && modifyClass("u_content_wrap", "background", jsThemeConfig.userMessageColor), addClass("u_2", "user_name"), modifyClass("user_name", "color", jsThemeConfig.userNameColor), addClass("u_3", "user_time"), setStyleRule(".user_time", "color: " + jsThemeConfig.userTimeColor + " !important"), addClass("u_4", "user_msg left_msg_bubble"), modifyClass("user_msg", "background", jsThemeConfig.userMessageColor), setStyleRule(".user_msg", "color: " + jsThemeConfig.userFontColor + " !important"), 2 == jsThemeConfig.themeSelect && "" == jsThemeConfig.userNameColor && "" == jsThemeConfig.userTimeColor && modifyClass("user_msg", "margin", "22px 30% 15px 10px;"), 3 == jsThemeConfig.themeSelect && (modifyClass("u_avatar_border", "background", jsThemeConfig.userMessageColor), "" == jsThemeConfig.userNameColor && modifyClass("user_name", "margin-left: 0px"), "none" == jsThemeConfig.userAvatarSelect && addClass("u_1", "user_avatar_ex")), 4 == jsThemeConfig.themeSelect && (setStyleRule(".left_msg_bubble::after", 'content: ""; position: absolute; border-style: solid; border-width: 0 12px 12px; border-color: ' + jsThemeConfig.userMessageColor + " transparent; display: block; width: 0; z-index: 1; top: -10px; left: 20px;"), "none" == jsThemeConfig.userAvatarSelect && (addClass("u_2", "user_name_ex"), addClass("u_3", "user_time_ex"))), 5 == jsThemeConfig.themeSelect && setStyleRule(".user_msg::after", 'border-radius: 20px / 10px;content: ""; display: block; position: absolute; border: 8px solid transparent; border-bottom-color: ' + jsThemeConfig.userMessageColor + "; bottom: 1px; left: -5px;"), "" == jsThemeConfig.userNameColor && modifyClass("user_name", "display", "none"), "" == jsThemeConfig.userTimeColor && modifyClass("user_time", "display", "none"), "50%" == jsThemeConfig.avatarRadius && (addClass("admin_avatar", "avatar_round"), addClass("user_avatar", "avatar_round")), "css" == jsThemeConfig.adminAvatarSelect) {
                var d = jsThemeConfig.adminAvatarCssContent;
                if ("dynamic" == jsThemeConfig.adminAvatarCssContentStyle)
                    if (null === sessionStorage.getItem("michat_support-jsSession--post_started")) d = "A";
                    else
                        for (var g = document.getElementsByClassName("a_1"), c = document.getElementsByClassName("a_2"), h = 0; h < g.length; h++) g[h].innerHTML = c[h].innerHTML.charAt(0).toUpperCase();
                else appendClassContent("admin_avatar", d);
                modifyClass("admin_avatar", "background-color", jsThemeConfig.adminAvatarColor), addClass("a_1", "a_css_text_color"), setStyleRule(".a_css_text_color", "color: " + jsThemeConfig.adminAvatarColorText + "; font-size:13px")
            }
            if ("img" == jsThemeConfig.adminAvatarSelect) {
                modifyClass("admin_avatar", "background-color", "transparent");
                var g = document.getElementsByClassName("a_1");
                if ("undefined" != sessionStorage.getItem("michat_support-jsSession--operator_avatar")) {
                    var u = JSON.parse(sessionStorage.getItem("michat_support-jsSession--operator_avatar"));
                    JSON.parse(sessionStorage.getItem("michat_support-jsSession--operator_name"));
                    if (u)
                        for (var C, h = 0; h < g.length; h++) C = "null" != u[h] && "" != u[h] ? dataAvatarAgent + u[h] : dataServer + "config/themes/img/avatars/default.png", g[h].innerHTML = '<img src="' + C + '"/>'
                }
                if ("" != jsThemeConfig.initMsgModule_2 && null === sessionStorage.getItem("michat_support-jsSession--post_started")) {
                    var C = dataServer + "config/themes/img/avatars/default.png";
                    if (void 0 == g[0]) return;
                    g[0].innerHTML = '<img src="' + C + '"/>'
                }
            }
            if ("css" == jsThemeConfig.userAvatarSelect && (appendClassContent("user_avatar", jsThemeConfig.userAvatarCssContent), modifyClass("user_avatar", "background-color", jsThemeConfig.userAvatarColor), addClass("u_1", "u_css_text_color"), setStyleRule(".u_css_text_color", "color: " + jsThemeConfig.userAvatarColorText + "; font-size:13px")), "img" == jsThemeConfig.userAvatarSelect)
                if ("true" == jsThemeConfig.userAvatarSelectChoice) {
                    var _ = sessionStorage.getItem("michat_support-jsSession--userAvatar");
                    appendClassContent("u_1", '<img src="' + _ + '"/>')
                } else appendClassContent("u_1", '<img src="' + jsThemeConfig.userAvatarFile + '"/>');
            "wide" == sessionStorage.getItem("michat_support-jsSession--widgetWidthMode") && (addClass("a_avatar_border", "a_avatar_border_wide"), addClass("a_content_wrap", "content_wrap_wide"), addClass("admin_msg", "admin_msg_wide"), addClass("u_avatar_border", "u_avatar_border_wide"), addClass("u_content_wrap", "content_wrap_wide"), addClass("user_msg", "user_msg_wide"))
        }
    }

    function showAvatarSelect() {
        function e() {
            var e = document.getElementById("avatar_holder").getElementsByTagName("li");
            e[0].parentNode.appendChild(e[0])
        }
        for (var t = dataServer + "config/themes/img/avatars/" + jsThemeConfig.userAvatarSet + "/", a = document.getElementById("avatar_list"), o = 0; o < jsThemeConfig.avatar_set_files.length; o++) {
            var s = document.createElement("li"),
                r = new Image;
            r.src = t + jsThemeConfig.avatar_set_files[o], s.appendChild(r), a.appendChild(s)
        }
        var l = document.querySelectorAll("#avatar_holder ul li").length,
            n = document.querySelectorAll("#avatar_holder ul li"),
            i = n[0].clientWidth,
            m = n[0].clientHeight;
        document.getElementById("avatar_holder").style.width = i, document.getElementById("avatar_holder").style.height = m, selectAvatar(), document.getElementById("control_prev").onclick = function() {
            for (var t = 0; l - 1 > t; t++) e();
            selectAvatar()
        }, document.getElementById("control_next").onclick = function() {
            e(), selectAvatar()
        }
    }

    function selectAvatar() {
        var e = document.querySelectorAll("#avatar_holder ul li img")[0].src;
        sessionStorage.setItem("michat_support-jsSession--userAvatar", e)
    }
    socket.on('SEND_INFORM_TO_AGENT', function(data) {
        if (data.visitor_jid == visitor_jid_queue.split('@')[0]) {
            $.ajax({
                url: 'https://demo-2021.midesk.vn/chat/infoUser/' + data.to_agent,
                type: "get",
                dataType: "json",
                async: !1,
                success: function(data) {
                    if (data.picture != '') {
                        user_pic = data.picture
                    } else {
                        user_pic = 'no_user_photo-v1.jpg'
                    }
                    var michat_header = '';
                    if (data.company) {
                        hotline = data.company
                    } else {
                        hotline = '19001238'
                    }
                    michat_header += '<table width="100%" style="font-size:14px;color:#fff;">\
                            <tr>\
                                <td width="10px" class="header-back"><span id="click_back"><img style="width:12px" src="https://demo-2021.midesk.vn/public/webchat/images/arrow.png"></span></td>\
                                <td width="10px" style="text-align:center;">\
                                    <div>\
                                        <img id="agent-avatar-header" src="' + dataAvatarAgent + user_pic + '">\
                                    </div>\
                                    <div id="online_icon"></div>\
                                </td>\
                                <td width="100px">\
                                    <div id="agent-title" data-id="'+data.id+'"><span>' + data.firstname + ' ' + data.lastname + '</span>';
                    if (jsThemeConfig.reviewChat == '1') {
                        michat_header += '<span style="float:right;padding-right:22px;"><span id="like_chat" style="cursor:pointer;padding: 5px;"><i class="fa fa-thumbs-o-up"></i></span><span id="unlike_chat" style="cursor:pointer;padding: 5px;"><i class="fa fa-thumbs-o-up" style="transform: rotate(180deg);"></i></span></span>'
                    }
                    michat_header += '</div>';
                    if (mi_group == 37) {
                        michat_header += '<div id="status-agent-title">Nhân viên tư vấn <br>(Hotline: ' + hotline + ')</div>'
                    } else {
                        michat_header += '<div id="status-agent-title">Nhân viên tư vấn</div>'
                    }
                    michat_header += '<div id="rating-and-transcript" style="display:none;">\
                                        <a class="rating-button rate-good" href="#" data-title="Rate as good" style="color:#fff"><i class="fa fa-thumbs-o-up" aria-hidden="true"></i></a> | \
                                        <a class="rating-button rate-bad" href="#" data-title="Rate as bad" style="color:#fff"><i class="fa fa-thumbs-o-down" aria-hidden="true"></i></a> | \
                                        <a href="#" data-title="Send the chat transcript to your e-mail" style="color:#fff"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>\
                                    </div>\
                                </td>';
                    if (jsThemeConfig.reviewChat == '0') {
                        michat_header += '<td width="10px">\
                                        <span id="click_down" title="Thu nhỏ chat" class="michat_options_btn" style="font-size: 10px; display: inline;"><i class="fa fa-window-minimize"></i></span>\
                                    </td>'
                    } else {
                        michat_header += '<td width="10px">\
                                        <span id="click_down" title="Thu nhỏ chat" class="michat_options_btn" style="font-size: 10px; display: inline;"><i class="fa fa-window-minimize"></i></span>\
                                    </td>'
                    }
                    michat_header += '</tr>\
                        </table>';
                    $('#michat_header').html(michat_header)
                }
            })
        } else {}
    })
    socket.on('CHECK_INVITE_CHAT', function(data) {
        // agentInvite(), setInterval(function() {
        //     agentInvite()
        // }, 5000)
    });
    // socket.on('NOTI_USER_ONLINE', function(data) {
    //     // console.log('==ONLINE==');
    //     // console.log(data);
    //     if($('#send_msg_m3').length == 1){
    //         location.reload();
    //     }
    //     // console.log('==END_ONLINE==');
    // });
    // socket.on('NOTI_USER_OFFLINE', function(data) {
    //     // console.log('==OFFLINE==');
    //     // console.log(data);
    //     // console.log('==END_OFFLINE==');
    //     // console.log($('#agent-title').data('id'));
    //     console.log($('#michat_button_online').length);
    //     if(data.userId == $('#agent-title').data('id') || $('#michat_button_online').length == 1){
    //         "true" != jsGlobalConfig.offline_hide && messageInit();
    //         socketWidget();
    //     }
    // //     if($('#send_msg_m3').length == 0 ){
    // //         location.reload();
    // //     }
    // });

    // setInterval(function() {
    //     $.ajax({
    //         url: 'https://demo-2021.midesk.vn/chat/swapAgent',
    //         type: "POST",
    //         dataType: 'json',
    //         async: false,
    //         data: {
    //             'Z3JvdXBpZA==': mi_group,
    //             'dmlzaXRvcl9qaWQ=': 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-'),
    //         },
    //         success: function(data) {
    //             if(data.status == 'true' && $('#send_msg_m3').length == 0){
    //                 location.reload();
    //             }
    //         }
    //     })
    // }, 100000);



    // setTimeout(function() {
    //     $.ajax({
    //         url: 'https://demo-2021.midesk.vn/chat/chatRequest',
    //         type: "POST",
    //         dataType: 'json',
    //         data: {
    //             'YWRkX2NoYXRfcmVxdWVzdA==': 'add_chat_request',
    //             'Z3JvdXBpZA==': mi_group,
    //             'bmFtZQ==': 'Guest',
    //             'Y29va2llX2lk': localStorage.getItem("michat_support-jsCookie"),
    //             'b3M=': jsGetVars.os,
    //             'YnJvd3Nlcg==': jsGetVars.browser,
    //             'YnJvd3Nlcl9sYW5n': jsGetVars.lang,
    //             'bW9iaWxl': jsGetVars.mobile,
    //             'c2NyZWVuX3NpemU=': jsGetVars.screen_size,
    //             'aXBfYWRkcmVzcw==': sessionStorage.getItem("michat_support-jsSession--ip_address"),
    //             'Y291bnRyeV9uYW1l': sessionStorage.getItem("michat_support-jsSession--country_name"),
    //             'Y291bnRyeV9jb2Rl': sessionStorage.getItem("michat_support-jsSession--country_code"),
    //             'bGlua19wb3J0YWw=': jsGetVars.current_url,
    //             'c2Vzc2lvbl9pZA==': sessionStorage.getItem("michat_support-jsSession"),
    //             'b3BlcmF0b3JzT25saW5l': checkOperator2(),
    //             'dmlzaXRvcl9qaWQ=': 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-'),
    //             'Y29va2llX3dpZGdldF9pZA==': jsGetVars.cookie_widget,
    //             'bG9jYXRpb24=': '',
    //             'cGxhdGZvcm0=': jsGetVars.os,
    //             'dXNlcl9hZ2VudA==': jsGetVars.os,
    //             'dXJsX3Zpc2l0': jsGetVars.current_url,
    //             'aG9zdF9uYW1l': jsGetVars.host_name,
    //             'cmVmX3VybA==': jsGetVars.ref_url,
    //         },
    //         success: function(data) {
    //             if (data == 1) {
    //                 getMonitor()
    //             }
    //         }
    //     })
    // }, 5000);
    var t;

    function allowInviteScan2() {
        if ("post-started" != sessionStorage.getItem("michat_support-jsSession--post_started")) {
            t = 0;
            var http = new XMLHttpRequest();
            var url = 'https://demo-2021.midesk.vn/chat/invite';
            var params = "jsCookie=" + localStorage.getItem("michat_support-jsCookie") + "&session_id=" + sessionStorage.getItem("michat_support-jsSession") + "&host_name=" + jsGetVars.host_name + "&groupid=" + mi_group;
            http.open("POST", url, !0);
            http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            http.onreadystatechange = function() {
                if (http.readyState == 4 && http.status == 200) {
                    if (http.responseText != 0 && t == 0) {
                        console.log('Invite chat !');
                        _invite_chat_flag = !0;
                        _agent_invite_flag = '_agent_invite_flag';
                        t = 1;
                        $(document).trigger('connect');
                        sessionStorage.setItem("michat_support-jsSession--user_name", "Guest");
                        sessionStorage.setItem("michat_support-jsSession--request_id", http.responseText);
                        sessionStorage.setItem("michat_support-jsSession--post_started", "post-started");
                        chatInit("Invited user", http.responseText)
                    }
                }
            }
            http.send(params)
        }
    }

    function agentInvite() {
        if ("post-started" != sessionStorage.getItem("michat_support-jsSession--post_started")) {
            t = 0;
            var http = new XMLHttpRequest();
            var url = 'https://demo-2021.midesk.vn/chat/invite';
            var params = "jsCookie=" + localStorage.getItem("michat_support-jsCookie") + "&session_id=" + sessionStorage.getItem("michat_support-jsSession") + "&host_name=" + jsGetVars.host_name + "&groupid=" + mi_group;
            http.open("POST", url, !0);
            http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            http.onreadystatechange = function() {
                if (http.readyState == 4 && http.status == 200) {
                    if (http.responseText != 0 && t == 0) {
                        _invite_chat_flag = !0;
                        _agent_invite_flag = '222';
                        t = 1;
                        $(document).trigger('connect');
                        sessionStorage.setItem("michat_support-jsSession--user_name", "Guest");
                        sessionStorage.setItem("michat_support-jsSession--request_id", http.responseText);
                        sessionStorage.setItem("michat_support-jsSession--post_started", "post-started");
                        chatInit("Invited user", http.responseText)
                    }
                }
            }
            http.send(params)
        }
    }

    function inviteScan() {
        $.ajax({
            url: 'https://demo-2021.midesk.vn/chat/inviteScan',
            type: "POST",
            dataType: 'json',
            data: {
                'aW52aXRlU2Nhbg==': 'inviteScan',
                'Y29va2llX2lk': localStorage.getItem("michat_support-jsCookie"),
                'c2Vzc2lvbl9pZA==': sessionStorage.getItem("michat_support-jsSession"),
            },
            success: function(data) {
                if (data != 0) {
                    sessionStorage.setItem("michat_support-jsSession--user_name", "Guest");
                    sessionStorage.setItem("michat_support-jsSession--request_id", data);
                    sessionStorage.setItem("michat_support-jsSession--post_started", "post-started");
                    chatInit("Invited user", data)
                }
            }
        })
    }

    function setSlideUpToggle(e) {
        if (document.getElementById("michat_btn_wrap")) {
            if ($("#danh_gia").remove(), $("#chat_history").css("opacity", "1"), slideToggleState = e, "default" == jsThemeConfig.triggerMethod && (slideToggleState = "open", "closed" == e ? (document.getElementById("michat_btn_wrap").style.display = "block", (document.getElementById("michat_holder").style.display = "none") && void 0 != document.getElementById("michat_close_btn") && (document.getElementById("michat_close_btn").style.display = "none")) : (document.getElementById("michat_holder").style.display = "block", void 0 != document.getElementById("michat_close_btn") && (document.getElementById("michat_close_btn").style.display = "block"), void 0 != document.getElementById("michat_start_btn") && (document.getElementById("michat_start_btn").style.display = "none"), window.addEventListener && ("wide" != sessionStorage.getItem("michat_support-jsSession--widgetWidthMode") ? parent.postMessage({
                    task: "iframe_resize"
                }, target_origin) : parent.postMessage({
                    task: "iframe_wide"
                }, target_origin))), void 0 != document.getElementById("michat_close_btn") && (document.getElementById("michat_close_btn").onclick = function() {
                    void 0 != document.getElementById("michat_close_btn") && (document.getElementById("michat_close_btn").style.display = "none"), void 0 != document.getElementById("michat_start_btn") && (document.getElementById("michat_start_btn").style.display = "block"), setSlideUpToggle("closed"), window.addEventListener && ("wide" != sessionStorage.getItem("michat_support-jsSession--widgetWidthMode") ? parent.postMessage({
                        task: "iframe_init_" + jsThemeConfig.triggerMethod
                    }, target_origin) : parent.postMessage({
                        task: "iframe_wide"
                    }, target_origin))
                })), "slideup" == jsThemeConfig.triggerMethod) {
                var F = document.getElementById("michat_holder"),
                    t = 40,
                    i = 400,
                    n = 400,
                    o = null,
                    s = "";
                "closed" == e ? (s = !1, F.style.height = t + "px") : (s = !0, slideToggleState = "open", F.style.height = i + "px"), document.getElementById("chat_link_holder").onclick = function() {
                    window.addEventListener && "40px" == F.style.height && ("wide" != sessionStorage.getItem("michat_support-jsSession--widgetWidthMode") ? parent.postMessage({
                        task: "iframe_resize"
                    }, target_origin) : parent.postMessage({
                        task: "iframe_wide"
                    }, target_origin)), void 0 != document.getElementById("op_is_typing") && (document.getElementById("op_is_typing").style.display = "none");
                    var e = document.getElementById("michat_holder").getAttribute("data-module"),
                        d = getStyle("michat_holder", "width");
                    i = "580px" == d ? 580 : 400, clearInterval(o);
                    var a = parseInt(F.style.height),
                        l = (new Date).getTime(),
                        r = (s = !s) ? i : t,
                        m = r - parseInt(F.style.height);
                    o = setInterval(function() {
                        var t = (new Date).getTime() - l;
                        if (n > t) {
                            var i = Math.floor(m * t / n),
                                s = a + i;
                            2 == e && "default" != jsThemeConfig.headerStyle && (45 > s ? (void 0 != document.getElementById("header_image") && (document.getElementById("header_image").style.display = "none"), void 0 != document.getElementById("header_subtext") && (document.getElementById("header_subtext").style.display = "none")) : (void 0 != document.getElementById("header_image") && (document.getElementById("header_image").style.display = "block"), void 0 != document.getElementById("header_subtext") && (document.getElementById("header_subtext").style.display = "block"))), void 0 != document.getElementById("michat_bottom_textarea_wrapper") && (s > 390 ? document.getElementById("michat_bottom_textarea_wrapper").style.display = "block" : document.getElementById("michat_bottom_textarea_wrapper").style.display = "none"), slideToggleState = 45 > s ? "closed" : "open", F.style.height = s + "px"
                        } else F.style.height = r + "px", clearInterval(o), window.addEventListener && "40px" == F.style.height && ("wide" != sessionStorage.getItem("michat_support-jsSession--widgetWidthMode") ? parent.postMessage({
                            task: "iframe_init_" + jsThemeConfig.triggerMethod
                        }, target_origin) : parent.postMessage({
                            task: "iframe_wide"
                        }, target_origin))
                    }, 1)
                }
            }
            if ("slideside" == jsThemeConfig.triggerMethod) {
                var d = "-330px";
                "closed" == e ? document.getElementById("michat_holder").style.marginRight = d : document.getElementById("michat_holder").style.marginRight = "0px", document.getElementById("michat_link_holder").onclick = function() {
                    var e = getStyle("michat_holder", "width");
                    d = "330px" == e ? "-330px" : "-580px";
                    var F = getStyle("michat_holder", "margin-right");
                    F == d ? (window.addEventListener && ("wide" != sessionStorage.getItem("michat_support-jsSession--widgetWidthMode") ? parent.postMessage({
                        task: "iframe_resize_" + jsThemeConfig.triggerMethod
                    }, target_origin) : parent.postMessage({
                        task: "iframe_wide"
                    }, target_origin)), document.getElementById("michat_holder").style.marginRight = "0px") : (document.getElementById("michat_holder").style.marginRight = d, window.addEventListener && ("wide" != sessionStorage.getItem("michat_support-jsSession--widgetWidthMode") ? setTimeout(function() {
                        parent.postMessage({
                            task: "iframe_init_" + jsThemeConfig.triggerMethod
                        }, target_origin)
                    }, 250) : setTimeout(function() {
                        parent.postMessage({
                            task: "iframe_wide"
                        }, target_origin)
                    }, 250)))
                }
            }
        }

        function getStyle(e, F) {
            var t, i = document.getElementById(e);
            return i.currentStyle ? t = i.currentStyle[F] : window.getComputedStyle && (t = document.defaultView.getComputedStyle(i, null).getPropertyValue(F)), t
        }


        function emojiPanel(e) {
            0 == emojiListenersActivated && (activateEmojiListeners(), emojiListenersActivated = !0, "twitter" == emojiFamily && twemoji.parse(document.getElementById("usc_emoji_picker"), {
                size: 72
            }));
            var F = document.getElementById("usc_emoji_picker");
            a = F.style.visibility, "" == a || "hidden" == a ? F.style.visibility = "visible" : "visible" != a && "close" != e || (F.style.visibility = "hidden")
        }

        function activateEmojiListeners() {
            function e() {
                0 != this.getAttribute("data-list") && t(this.getAttribute("data-hex")), F('<img class="usc_emoji_lg" src="' + this.firstChild.getAttribute("src") + '" />', wysiwygNode)
            }

            function F(e, F) {
                if (wysiwygNode.innerHTML = wysiwygNode.innerHTML + e, F.focus(), "undefined" != typeof window.getSelection && "undefined" != typeof document.createRange) {
                    var t = document.createRange();
                    t.selectNodeContents(F), t.collapse(!1);
                    var i = window.getSelection();
                    i.removeAllRanges(), i.addRange(t)
                } else if ("undefined" != typeof document.body.createTextRange) {
                    var n = document.body.createTextRange();
                    n.moveToElementText(F), n.collapse(!1), n.select()
                }
            }

            function t(F) {
                n.unshift(F), n = i(n), n.length >= 72 && n.pop(), localStorage.setItem("USC-recently-used-emoji", JSON.stringify(n)), y = "";
                for (var t = 0; t < n.length; t++) y += '<li data-list="0" data-hex="' + n[t] + '">&#x' + n[t] + "</li>";
                recentEmojiContentHolder = document.getElementById("content0"), recentEmojiContentHolder.innerHTML = '<ul id="emoji-list-0" class="emoji-list">' + y + "</ul>", twemoji.parse(recentEmojiContentHolder, {
                    size: 72
                }), emojiList_0 = document.getElementById("emoji-list-0").getElementsByTagName("li");
                for (var t = 0; t < emojiList_0.length; t++) emojiList_0[t].addEventListener("click", e, !1)
            }

            function i(e) {
                for (var F = [], t = 0; t < e.length; t++) - 1 == F.indexOf(e[t]) && F.push(e[t]);
                return F
            }
            var n = JSON.parse(localStorage.getItem("USC-recently-used-emoji"));
            null == n && (n = ["1F600", "1F601", "1F602"], localStorage.setItem("USC-recently-used-emoji", JSON.stringify(n)));
            var o = ["1F600", "1F601", "1F602", "1F603", "1F604", "1F605", "1F606", "1F607", "1F608", "1F609", "1F60A", "263A", "1F60B", "1F60C", "1F60D", "1F60E", "1F60F", "1F610", "1F611", "1F612", "1F613", "1F614", "1F615", "1F616", "1F617", "1F618", "1F619", "1F61A", "1F61B", "1F61C", "1F61D", "1F61E", "1F61F", "1F620", "1F621", "1F622", "1F623", "1F624", "1F625", "1F626", "1F627", "1F628", "1F629", "1F62A", "1F62B", "1F62C", "1F62D", "1F62E", "1F62F", "1F630", "1F631", "1F632", "1F633", "1F634", "1F635", "1F636", "1F637", "1F638", "1F639", "1F63A", "1F63B", "1F63C", "1F63D", "1F63E", "1F63F", "1F640", "1F47D", "1F47E", "1F47F", "1F480"],
                s = ["1F445", "1F446", "1F447", "1F448", "1F449", "1F44A", "1F44B", "1F44C", "1F44D", "1F44E", "1F44F", "1F450", "270A", "270B", "270C", "261D", "1F4AA", "1F4A9", "1F451", "1F452", "1F453", "1F454", "1F455", "1F456", "1F457", "1F458", "1F459", "1F45A", "1F45B", "1F45C", "1F45D", "1F45E", "1F45F", "1F460", "1F461", "1F462", "1F463", "1F464", "1F465", "1F466", "1F467", "1F468", "1F469", "1F46A", "1F46B", "1F46C", "1F46D", "1F46E", "1F46F", "1F470", "1F471", "1F472", "1F473", "1F474", "1F475", "1F476", "1F477", "1F478", "1F479", "1F47A", "1F47B", "1F47C", "1F481", "1F482", "1F483", "1F484", "1F485", "1F486", "1F487", "1F488", "1F489", "1F48A", "1F48B", "1F48C", "1F48D", "1F48E", "1F48F", "1F490", "1F491", "1F492", "1F493", "1F494", "1F495", "1F496", "1F497", "1F498", "1F499", "1F49A", "1F49B", "1F49C", "1F49D", "1F49E", "1F49F", "1F440", "1F442", "1F443", "1F444", "1F645", "1F646", "1F647", "1F648", "1F649", "1F64A", "1F64B", "1F64C", "1F64D", "1F64E", "1F64F"],
                d = ["2708", "1F680", "1F681", "1F682", "1F683", "1F684", "1F685", "1F686", "1F687", "1F688", "1F689", "1F68A", "1F68B", "1F68C", "1F68D", "1F68E", "1F68F", "1F690", "1F691", "1F692", "1F693", "1F694", "1F695", "1F696", "1F697", "1F698", "1F699", "1F69A", "1F69B", "1F69C", "1F69D", "1F69E", "1F69F", "1F6A0", "1F6A1", "1F6A2", "1F6A3", "1F6A4", "1F6A5", "1F6A6", "1F6A7", "1F6A8", "1F6A9", "1F6AA", "1F6AB", "1F6AC", "1F6AD", "1F6AE", "1F6AF", "1F6B2", "1F6B3", "1F6B4", "1F6B5", "1F6B6", "1F6B7", "1F6B8"],
                a = ["1F301", "1F303", "1F304", "1F305", "1F306", "1F307", "1F308", "1F309", "1F30A", "1F30B", "1F30C", "1F30D", "1F30E", "1F30F", "1F310", "1F311", "1F312", "1F313", "1F314", "1F315", "1F316", "1F317", "1F318", "1F319", "1F31A", "1F31B", "1F31C", "1F31D", "1F31E", "1F4A7", "1F4A8", "26C5", "2600", "2601", "1F31F", "1F320", "1F330", "1F331", "1F332", "1F333", "1F334", "1F335", "1F337", "1F338", "1F339", "1F33A", "1F33B", "1F33C", "1F33D", "1F33E", "1F33F", "1F340", "1F341", "1F342", "1F343"],
                l = ["1F362", "1F363", "1F364", "1F365", "1F366", "1F367", "1F368", "1F369", "1F36A", "1F36B", "1F36C", "1F36D", "1F36E", "1F36F", "1F370", "1F371", "1F372", "1F373", "1F374", "1F375", "1F376", "1F377", "1F378", "1F379", "1F37A", "1F37B", "1F37C", "1F380", "1F381", "1F382", "1F344", "1F345", "1F346", "1F347", "1F348", "1F349", "1F34A", "1F34B", "1F34C", "1F34D", "1F34E", "1F34F", "1F350", "1F351", "1F352", "1F353", "1F354", "1F355", "1F356", "1F357", "1F358", "1F359", "1F35A", "1F35B", "1F35C", "1F35D", "1F35E", "1F35F", "1F360", "1F361"],
                r = ["1F384", "1F385", "1F386", "1F387", "1F388", "1F389", "1F38A", "1F38B", "1F38C", "1F38D", "1F38E", "1F38F", "1F390", "1F391", "26FA", "1F392", "1F393", "1F3A0", "1F3A1", "1F3A2", "1F3A3", "1F3A4", "1F3A5", "1F3A6", "1F3A7", "1F3A8", "1F3A9", "1F3AA", "1F3AB", "1F3AC", "1F3AD", "1F3AE", "1F3AF", "1F3B0", "1F3B1", "1F3B2", "1F3B3", "1F3B4", "1F3B5", "1F3B6", "1F3B7", "1F3B8", "1F3B9", "1F3BA", "1F3BB", "1F3BC", "1F3BD", "1F3BE", "1F3BF", "1F3C0", "1F3C1", "1F3C2", "1F3C3", "1F3C4", "1F3C6", "1F3C7", "1F3C8", "1F3C9", "1F3CA", "1F3E0", "1F3E1", "1F3E2", "1F3E3", "1F3E4", "1F3E5", "1F3E6", "1F3E7", "1F3E8", "1F3E9", "1F3EA", "1F3EB", "1F3EC", "1F3ED", "1F3EE", "1F3EF", "1F3F0", "26EA", "1F5FB", "1F5FC", "1F5FD", "1F5FE", "1F5FF"],
                m = ["1F400", "1F401", "1F402", "1F403", "1F404", "1F405", "1F406", "1F407", "1F408", "1F409", "1F40A", "1F40B", "1F40C", "1F40D", "1F40E", "1F40F", "1F410", "1F411", "1F412", "1F413", "1F414", "1F415", "1F416", "1F417", "1F418", "1F419", "1F41A", "1F41B", "1F41C", "1F41D", "1F41E", "1F41F", "1F420", "1F421", "1F422", "1F423", "1F424", "1F425", "1F426", "1F427", "1F428", "1F429", "1F42A", "1F42B", "1F42C", "1F42D", "1F42E", "1F42F", "1F430", "1F431", "1F432", "1F433", "1F434", "1F435", "1F436", "1F437", "1F438", "1F439", "1F43A", "1F43B", "1F43C", "1F43D", "1F43E"],
                g = ["1F4A0", "1F4A1", "1F4A2", "1F4A3", "1F4A4", "1F4A5", "1F4A6", "1F4AB", "1F4AC", "1F4AD", "1F4AE", "1F4AF", "1F4B0", "1F4B1", "1F4B2", "1F4B3", "1F4B4", "1F4B5", "1F4B6", "1F4B7", "1F4B8", "1F4B9", "1F4BA", "1F4BB", "1F4BC", "1F4BD", "1F4BE", "1F4BF", "1F4C0", "1F4C1", "1F4C2", "1F4C3", "1F4C4", "1F4C5", "1F4C6", "1F4C7", "1F4C8", "1F4C9", "1F4CA", "1F4CB", "1F4CC", "1F4CD", "1F4CE", "1F4CF", "1F4D0", "1F4D1", "1F4D2", "1F4D3", "1F4D4", "1F4D5", "1F4D6", "1F4D7", "1F4D8", "1F4D9", "1F4DA", "1F4DB", "1F4DC", "1F4DD", "1F4DE", "1F4DF", "1F4E0", "1F4E1", "1F4E2", "1F4E3", "1F4E4", "1F4E5", "1F4E6", "1F4E7", "1F4E8", "1F4E9", "1F4EA", "1F4EB", "1F4EC", "1F4ED", "1F4EE", "1F4EF", "1F4F0", "1F4F1", "1F4F2", "1F4F3", "1F4F4", "1F4F5", "1F4F6", "1F4F7", "1F4F9", "1F4FA", "1F4FB", "1F4FC", "1F500", "1F507", "1F508", "1F50A", "1F50B", "1F50C", "1F50D", "1F50E", "1F50F", "1F510", "1F511", "1F512", "1F513", "1F514", "1F515", "1F516", "1F517", "1F518", "1F51E", "1F524", "1F525", "1F526", "1F527", "1F528", "1F529", "1F52A", "1F52B", "1F52C", "1F52D", "1F52E", "1F52F", "1F530", "1F531", "1F559", "1F6B9", "1F6BA", "1F6BB", "1F6BC", "1F6BD", "1F6BE", "1F6BF", "1F6C0", "1F6C1", "1F6C2", "1F6C3", "1F6C4", "1F6C5", "203C", "2049", "2122", "2139", "231A", "231B", "23F0", "23F3", "24C2", "260E", "2611", "1F302", "2614", "2615", "2648", "2649", "264A", "264B", "264C", "264D", "264E", "264F", "2650", "2651", "2652", "2653", "2660", "2663", "2665", "2666", "2668", "267B", "267F", "2693", "26A0", "26A1", "26AA", "26AB", "26BD", "26BE", "26C4", "26CE", "26D4", "26F2", "26F3", "26F5", "26FD", "2702", "2705", "2709", "270F", "2712", "2714", "2716", "2728", "2733", "2734", "1F505", "1F506", "2744", "2747", "274C", "274E", "2753", "2754", "2755", "2757", "2764", "2795", "1F004", "1F0CF"];
            if (null !== document.getElementById("usc_wysiwyg")) {
                var B = n,
                    E = [B, o, s, d, a, l, r, m, g];
                for (c = 0; c <= 8; c++) {
                    var y = "";
                    for (u = 0; u < E[c].length; u++) y += '<li data-list="' + c + '" data-hex="' + E[c][u] + '">&#x' + E[c][u] + "</li>";
                    document.getElementById("emoji-list-" + c).innerHTML = y
                }
                var h;
                for (c = 0; c <= 8; c++) {
                    h = document.getElementById("emoji-list-" + c).getElementsByTagName("li");
                    for (var u = 0; u < h.length; u++) h[u].addEventListener("click", e, !1)
                }
            }
        }
    }

    function socketWidget() {
        void 0 != document.getElementById("michat_start_btn") && (document.getElementById("michat_start_btn").onclick = function() {
            setSlideUpToggle("open")
        }), void 0 != document.getElementById("start_chat_m1") && (document.getElementById("start_chat_m1").onsubmit = function() {
            var e = "usc_client",
                t = "";
            if (1 == jsThemeConfig.requireName && (e = document.getElementById("username").value, "" == e)) {
                alert('Vui lòng nhập đầy đủ thông tin');
                return !1
            }
            if (1 == jsThemeConfig.requirePhone && (f = document.getElementById("phone").value, "" == f)) {
                alert('Vui lòng nhập đầy đủ thông tin');
                return !1
            }
            if (1 == jsThemeConfig.requireEmail) {
                if (t = document.getElementById("useremail").value, "" == t) {
                    alert('Vui lòng nhập đầy đủ thông tin');
                    return !1
                }
            }
            $.ajax({
                url: 'https://demo-2021.midesk.vn/chat/agentSupport',
                type: "POST",
                async: !1,
                data: {
                    'Z3JvdXBpZA==': mi_group,
                    'c3VwcG9ydF90eXBlX2lk': $('select[name=support_type]').val(),
                    'aG9zdF9uYW1l': jsGetVars.host_name,
                    'dXJsX3Zpc2l0': jsGetVars.current_url
                },
                success: function(data) {
                    console.log(data);
                    if (data == 'ONLINE') {
                        $(document).trigger('connect', {
                            jid: $('#username').val().toLowerCase(),
                            email: $('#email').val()
                        });
                        $.ajax({
                            url: 'https://demo-2021.midesk.vn/chat/startChat',
                            type: "POST",
                            dataType: 'json',
                            async: !1,
                            data: {
                                'jsCookie': localStorage.getItem("michat_support-jsCookie"),
                                'encodedGetVars': encodedGetVars,
                                'country_name': sessionStorage.getItem("michat_support-jsSession--country_name"),
                                'country_code': sessionStorage.getItem("michat_support-jsSession--country_code"),
                                'longitude': sessionStorage.getItem("michat_support-jsSession--longitude"),
                                'latitude': sessionStorage.getItem("michat_support-jsSession--latitude"),
                                'avatar': sessionStorage.getItem("michat_support-jsSession--userAvatar"),
                                'username': e,
                                'useremail': t,
                                'session_id': sessionStorage.getItem("michat_support-jsSession"),
                            },
                            success: function(data) {
                                // $('#googleTag').load('https://demo-2021.midesk.vn/chat/googleTag');
                                request_id = data.request_id;
                                if (data.request_id != '') {
                                    sessionStorage.setItem("michat_support-jsSession--user_name", data.user_name);
                                    sessionStorage.setItem("michat_support-jsSession--request_id", data.request_id);
                                    sessionStorage.setItem("michat_support-jsSession--widget_chat_length", "1")
                                    chatInit(e, data.request_id)
                                } else {
                                    document.getElementById("returned_msg").innerHTML = "Start chat error"
                                }
                            }
                        })
                    } else {
                        alert('Hiện tại không có nhân viên hỗ trợ.');
                        console.log('----1111----')
                    }
                }
            })
        }), void 0 != document.getElementById("send_msg_m3") && (document.getElementById("send_msg_m3").onsubmit = function() {
            var e = document.getElementById("contact_name").value,
                t = document.getElementById("contact_email").value,
                a = document.getElementById("contact_message").value;
            if ("" == e || "" == t || "" == a) {
                alert('Vui lòng nhập đầy đủ thông tin');
                return !1
            }
            $.ajax({
                url: 'https://demo-2021.midesk.vn/chat/sendEmail',
                type: "POST",
                dataType: 'json',
                async: !1,
                data: {
                    'contact_name': e,
                    'contact_email': t,
                    'contact_message': a,
                    'encodedGetVars': encodedGetVars,
                    'email_agent': jsThemeConfig.emailOfflineMsg,
                },
                success: function(data) {}
            })
        }), window.addEventListener("beforeunload", onbeforeunload);
        var adminWelcomeMsg;
        "true" == allowInvite && null == sessionStorage.getItem("michat_support-jsSession--post_started") && (allowInviteScan2(), setTimeout(function() {
            allowInviteScan2()
        }, 5000));
        var slideToggleState = "";
        emojiListenersActivated = !1;
        // var iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        // 1 == iOS && (document.getElementsByTagName("input")[0].addEventListener("focus", function() {
        //     parent.postMessage({
        //         task: "iOS_focus"
        //     }, target_origin)
        // }), document.getElementsByTagName("input")[0].addEventListener("blur", function() {
        //     parent.postMessage({
        //         task: "iOS_blur"
        //     }, target_origin)
        // }), document.getElementsByTagName("input")[1].addEventListener("focus", function() {
        //     parent.postMessage({
        //         task: "iOS_focus"
        //     }, target_origin)
        // }), document.getElementsByTagName("input")[1].addEventListener("blur", function() {
        //     parent.postMessage({
        //         task: "iOS_blur"
        //     }, target_origin)
        // }), document.getElementById("usc_wysiwyg").addEventListener("focus", function() {
        //     parent.postMessage({
        //         task: "iOS_focus"
        //     }, target_origin)
        // }), document.getElementById("usc_wysiwyg").addEventListener("blur", function() {
        //     parent.postMessage({
        //         task: "iOS_blur"
        //     }, target_origin)
        // }))
    }
    if ("all" == jsGlobalConfig.allowedDomains && (target_origin = jsGetVars.origin), void 0 == jsGlobalConfig.allowedDomains || "limited" == jsGlobalConfig.allowedDomains) {
        for (var allowedDomainsList = jsGlobalConfig.allowedDommainsList.split(","), i = 0; i < allowedDomainsList.length; i++)
            allowedDomainsList[i] = allowedDomainsList[i].trim();
        var allowedDomainBool = allowedDomainsList.indexOf(jsGetVars.origin) > -1;
        allowedDomainBool === !0 && (target_origin = jsGetVars.origin)
    }
    window.addEventListener && parent.postMessage({
        task: "iframe_init_" + jsThemeConfig.triggerMethod
    }, target_origin);
    var browser = getBrowserNoVersion(jsGetVars.browser);
    if (sessionStorage.setItem("michat_support-current_url", jsGetVars.current_url), sessionStorage.setItem("michat_support-ref_url", jsGetVars.ref_url), sessionStorage.setItem("michat_support-current_url", jsGetVars.current_url), sessionStorage.setItem("michat_support-ref_url", jsGetVars.ref_url), null === localStorage.getItem("michat_support-jsCookie")) {
        var jsCookieID = generateJsUniqueID();
        localStorage.setItem("michat_support-jsCookie", jsCookieID), initTracker2()
    } else null !== localStorage.getItem("michat_support-jsCookie") && null === sessionStorage.getItem("michat_support-jsSession") ? initTracker2() : jsGetVars.ip_address != sessionStorage.getItem("michat_support-jsSession--ip_address") ? initTracker2() : null !== sessionStorage.getItem("michat_support-jsSession--page_before_refresh") && null === sessionStorage.getItem("michat_support-jsSession--post_started") && sessionStorage.getItem("michat_support-current_url") != sessionStorage.getItem("michat_support-jsSession--page_before_refresh") && "all" == trackPages && trackerPing2();
    if ("slideside" == jsThemeConfig.triggerMethod) {
        var holderBorder = "";
        "" != jsThemeConfig.widgetBorder && (holderBorder = "border:1px solid " + jsThemeConfig.widgetBorder + "; border-top:none; ");
        var headerBorder = "";
        "" != jsThemeConfig.widgetBorder && (headerBorder = "border:1px solid ");
        var headerShadow = "",
            bodyShadow = "";
        "true" == jsThemeConfig.widgetShadow && (headerShadow = ";box-shadow: -5px 0px 35px -10px #000; -webkit-box-shadow: -5px 0px 35px -10px #000;", bodyShadow = ";box-shadow: 0px 15px 35px -10px #000; -webkit-box-shadow: 0px 15px 35px -10px #000;", "Microsoft" == browser && (headerShadow = ";box-shadow: -5px 0px 42px -10px #000;", bodyShadow = ";box-shadow: 0px 15px 42px -10px #000;"));
        var addHeaderImages = "",
            slidesideTextMargin = "",
            slidesideHeaderMargin = "";
        "none" != jsThemeConfig.headerImageType, jsThemeConfig.widgetBackgroundImg = "", jsThemeConfig.headerBackgroundImg = "", "image" == jsThemeConfig.backgroundStyle && (jsThemeConfig.backgroundColor = "transparent")
    } else {
        var borderBool = "";
        "" != jsThemeConfig.widgetBorder && (borderBool = "border:1px solid ");
        var shadowBool = "";
        "true" == jsThemeConfig.widgetShadow && (shadowBool = ";box-shadow: 0 5px 35px -10px #000; -webkit-box-shadow: 0 5px 35px -10px #000", "Microsoft" == browser && (shadowBool = ";box-shadow: 0 5px 42px -10px #000;")), addHeaderImages = "", jsThemeConfig.widgetBackgroundImg = "", jsThemeConfig.headerBackgroundImg = ""
    }
    var headerColor = "background-color:" + jsThemeConfig.headerColor + ";";
    if ("" != jsThemeConfig.headerGradient && (headerColor = "background-image: -ms-linear-gradient(right, " + jsThemeConfig.headerGradient + " 0%, " + jsThemeConfig.headerColor + " 100%);background-image: -o-linear-gradient(right, " + jsThemeConfig.headerGradient + " 0%, " + jsThemeConfig.headerColor + " 100%);background:linear-gradient(right," + jsThemeConfig.headerGradient + "," + jsThemeConfig.headerColor + ");background:-webkit-linear-gradient(right," + jsThemeConfig.headerGradient + "," + jsThemeConfig.headerColor + ");background:-moz-linear-gradient(right," + jsThemeConfig.headerGradient + "," + jsThemeConfig.headerColor + ");"), "default" == jsThemeConfig.triggerMethod) {
        var widgetButtonColor = "background:" + jsThemeConfig.widgetButtonColor + ";";
        "" != jsThemeConfig.widgetButtonColorGradient && (widgetButtonColor = "background-image: -ms-linear-gradient(right, " + jsThemeConfig.widgetButtonColorGradient + " 0%, " + jsThemeConfig.widgetButtonColor + " 100%);background-image: -o-linear-gradient(right, " + jsThemeConfig.widgetButtonColorGradient + " 0%, " + jsThemeConfig.widgetButtonColor + " 100%);background:linear-gradient(right," + jsThemeConfig.widgetButtonColorGradient + "," + jsThemeConfig.widgetButtonColor + ");background:-webkit-linear-gradient(right," + jsThemeConfig.widgetButtonColorGradient + "," + jsThemeConfig.widgetButtonColor + ");background:-moz-linear-gradient(right," + jsThemeConfig.widgetButtonColorGradient + "," + jsThemeConfig.widgetButtonColor + ");")
    }
    var m1BtnBackground = "background:" + jsThemeConfig.chatBtnMsgBackgroundColor + ";";
    "" != jsThemeConfig.chatBtnMsgBackgroundGradient && (m1BtnBackground = "background-image: -ms-linear-gradient(right, " + jsThemeConfig.chatBtnMsgBackgroundGradient + " 0%, " + jsThemeConfig.chatBtnMsgBackgroundColor + " 100%);background-image: -o-linear-gradient(right, " + jsThemeConfig.chatBtnMsgBackgroundGradient + " 0%, " + jsThemeConfig.chatBtnMsgBackgroundColor + " 100%);background:linear-gradient(right," + jsThemeConfig.chatBtnMsgBackgroundGradient + "," + jsThemeConfig.chatBtnMsgBackgroundColor + ");background:-webkit-linear-gradient(right," + jsThemeConfig.chatBtnMsgBackgroundGradient + "," + jsThemeConfig.chatBtnMsgBackgroundColor + ");background:-moz-linear-gradient(right," + jsThemeConfig.chatBtnMsgBackgroundGradient + "," + jsThemeConfig.chatBtnMsgBackgroundColor + ");");
    var m3BtnBackground = "background:" + jsThemeConfig.sendMailBtnBackgroundColor + ";";
    "" != jsThemeConfig.sendMailBtnBackgroundGradient && (m3BtnBackground = "background-image: -ms-linear-gradient(right, " + jsThemeConfig.sendMailBtnBackgroundGradient + " 0%, " + jsThemeConfig.sendMailBtnBackgroundColor + " 100%);background-image: -o-linear-gradient(right, " + jsThemeConfig.sendMailBtnBackgroundGradient + " 0%, " + jsThemeConfig.sendMailBtnBackgroundColor + " 100%);background:linear-gradient(right," + jsThemeConfig.sendMailBtnBackgroundGradient + "," + jsThemeConfig.sendMailBtnBackgroundColor + ");background:-webkit-linear-gradient(right," + jsThemeConfig.sendMailBtnBackgroundGradient + "," + jsThemeConfig.sendMailBtnBackgroundColor + ");background:-moz-linear-gradient(right," + jsThemeConfig.sendMailBtnBackgroundGradient + "," + jsThemeConfig.sendMailBtnBackgroundColor + ");");
    var requireName = "",
        requireEmail = "",
        requirePhone = "",
        requireSupportType = "";
    1 == jsThemeConfig.requireName && (requireName = '<div style="padding-top:20px;"><label style="margin-left: 40px;font-size: 13px; font-weight: bold;color: #666666">Nhập thông tin của bạn (*)</label></div><input type="text" class="michat_input_m1" placeholder="' + jsThemeConfig.m1PlaceholderTextName + '" id="username" name="username" value="" required/>'), 1 == jsThemeConfig.requireEmail && (requireEmail = '<input type="email" class="michat_input_m1" placeholder="' + jsThemeConfig.m1PlaceholderTextEmail + '" id="useremail" name="useremail" value="" required/>'), 1 == jsThemeConfig.requirePhone && (requirePhone = '<input type="text" class="michat_input_m1" placeholder="Nhập số điện thoại của bạn" id="phone" name="phone" value="" onkeypress="return event.charCode >= 48 && event.charCode <= 57" maxlength = "11" style="background: rgb(255, 255, 255);color: rgb(0, 0, 0);" required/>'), 1 == jsThemeConfig.requireSupportType && ($.ajax({
        url: 'https://demo-2021.midesk.vn/chat/supportType',
        type: "POST",
        dataType: 'json',
        async: !1,
        data: {
            'groupid': mi_group,
        },
        success: function(data) {
            if(mi_group != 133){   // gtv
                requireSupportType += '<div><label style="margin-left: 40px;font-size: 13px; font-weight: bold;color: #666666">Chọn dịch vụ hỗ trợ</label></div><select class="michat_input_m1" id="support_type" name="support_type" style="background: rgb(255, 255, 255);color: rgb(0, 0, 0);" required><option value="">- Chọn 1 dịch vụ hỗ trợ -</option>';
                $.each(data, function(key, value) {
                    requireSupportType += '<option value="' + key + '">' + value + '</option>'
                });
                requireSupportType += '</select>'
            }
        }
    }));
    var mark_up_var1 = "";
    "default" == jsThemeConfig.triggerMethod && (mark_up_var1 = '<span class="michat_close_holder" id="michat_close_holder"><icon class="' + jsThemeConfig.triggerMethod + '_chaticon_s"   style="color:' + jsThemeConfig.headerTextColor + '"></icon></span></div>'), "slideup" == jsThemeConfig.triggerMethod && (mark_up_var1 = '<span class="michat_link_holder" id="chat_link_holder"><icon class="' + jsThemeConfig.triggerMethod + '_chaticon" data-icon="e" style="color:' + jsThemeConfig.headerTextColor + '"></icon></span></div>'), "slideside" == jsThemeConfig.triggerMethod && (mark_up_var1 = "");
    var buttonTriggerVar = "",
        mark_up_var2 = "";
    "default" == jsThemeConfig.triggerMethod && (buttonTriggerVar = '<div class="michat_btn_wrap" id="michat_btn_wrap"><div class="michat_start_btn" id="michat_start_btn"  style="' + widgetButtonColor + '"></div><div class="michat_close_btn " id="michat_close_btn"  style="' + widgetButtonColor + '"></div></div>', mark_up_var2 = buttonTriggerVar), "slideside" == jsThemeConfig.triggerMethod && (mark_up_var2 = "</div>");
    var mark_up_var_init = "",
        ultimate_chat_holder = "",
        ultimate_chat_holder_slideside = "",
        slideside_link_holder = "",
        ultimate_chat_header = "",
        ultimate_chat_header_text = "",
        slideside_shadow_eraser = "",
        slideside_header_text = "";
    "slideside" == jsThemeConfig.triggerMethod ? (ultimate_chat_holder_slideside = '<div class="michat_holder holder_' + jsThemeConfig.triggerMethod + '" id="michat_holder" style=";' + holderBorder + shadowBool + ";border-top-left-radius: " + jsThemeConfig.widgetRadius + ";border-top-right-radius: " + jsThemeConfig.widgetRadius + ";background:" + jsThemeConfig.backgroundColor + bodyShadow + '" ', slideside_link_holder = '<div class="michat_link_holder_' + jsThemeConfig.triggerMethod + '" id="michat_link_holder" style=";' + headerColor + ";" + headerBorder + jsThemeConfig.widgetBorder + headerShadow + ";border-top-left-radius: " + jsThemeConfig.widgetRadius + ";border-top-right-radius: " + jsThemeConfig.widgetRadius + ";border-bottom-left-radius: " + jsThemeConfig.widgetRadius + ';border-right:none;"><icon class="' + jsThemeConfig.triggerMethod + '_chaticon" data-icon="e" style="color:' + jsThemeConfig.headerTextColor + '"></icon></div>', slideside_shadow_eraser = '<div class="michat_shadow_eraser" style="background:' + jsThemeConfig.backgroundColor + '"></div>', slideside_header_text = '<div id="michat_header_text" class="michat_header_text" style="color:' + jsThemeConfig.headerTextColor + '">', mark_up_var_init = ultimate_chat_holder_slideside + ' data-module="1" >' + slideside_link_holder + slideside_shadow_eraser + slideside_header_text + jsThemeConfig.headerTextM1 + "</div>") : (ultimate_chat_holder = '<div class="michat_holder" id="michat_holder"style="' + ("default" == jsThemeConfig.triggerMethod ? "style='display:none'" : "") + ";" + borderBool + jsThemeConfig.widgetBorder + shadowBool + ";border-top-left-radius: " + jsThemeConfig.widgetRadius + ";border-top-right-radius: " + jsThemeConfig.widgetRadius + ";background:" + jsThemeConfig.backgroundColor + '" ', ultimate_chat_header = '<div class="michat_header" id="michat_header" style="' + headerColor + '">', ultimate_chat_header_text = '<span class="header_text" style="color:' + jsThemeConfig.headerTextColor + '">', mark_up_var_init = ultimate_chat_holder + ' data-module="1" >' + ultimate_chat_header + ultimate_chat_header_text + jsThemeConfig.headerTextM1 + "</span>" + mark_up_var1);
    var mark_up = mark_up_var_init + '<div class="michat_invite_message" style="display:none;color:' + jsThemeConfig.initMsgColor + '">' + jsThemeConfig.initMsgModule_1 + '</div><div id="user_avatar_wrapper" style="display:none; margin-bottom: 20px;"><span id="control_prev" class="control_prev" style="' + m1BtnBackground + "; color:" + jsThemeConfig.chatBtnMsgFontColor + '"><</span><span id="control_next" class="control_next" style="' + m1BtnBackground + "; color:" + jsThemeConfig.chatBtnMsgFontColor + '">></span><div id="avatar_holder"><ul id="avatar_list" class="avatar_li"></ul></div></div><form id="start_chat_m1" method="post" style="height: 79%; overflow-y: auto;">' + requireName + requireEmail + requirePhone + requireSupportType + '<input type="submit" id="michat_button_online" class="michat_button" value="' + jsThemeConfig.chatBtnMsg + '" style="' + m1BtnBackground + " color:" + jsThemeConfig.chatBtnMsgFontColor + '"/></form><div id="returned_msg" style="color:red; line-height: 0; text-align: center;"></div><div id="michat_bottom_textarea_wrapper" style="bottom:0px;background-color: ' + jsThemeConfig.textarea2BackgroundColor + ';border-bottom-left-radius: 8px;border-bottom-right-radius: 8px;"><div style="height:100%;background-color:#fbfbfc;"></div><div id="footer-company">'+watermark_html+'</div></div></div></div></div>' + mark_up_var2,
        chatMarkup_init = "";
    "default" == jsThemeConfig.triggerMethod && (chatMarkup_init = ultimate_chat_holder + ' data-module="2" ><div class="michat_header" id="michat_header" style="' + headerColor + '"><span class="header_image" id="header_image">' + addHeaderImages + '</span><span class="header_text" style="color:' + jsThemeConfig.headerTextColor + '">' + jsThemeConfig.headerTextM2 + '<span id="end_chat_btn" title="Đánh giá chat" class="michat_options_btn" onclick="showOptions()" style="display:none;"><i class="fa fa-check-square-o"></i></span></div>'), "slideup" == jsThemeConfig.triggerMethod && (chatMarkup_init = ultimate_chat_holder + ' data-module="2" ><div class="michat_header" id="michat_header" style="' + headerColor + '"><span class="header_image" id="header_image">' + addHeaderImages + '</span><span class="header_text" style="color:' + jsThemeConfig.headerTextColor + '">' + jsThemeConfig.headerTextM2 + '</span><span class="michat_link_holder" id="chat_link_holder"><icon class="' + jsThemeConfig.triggerMethod + '_chaticon" data-icon="e" style="color:' + jsThemeConfig.headerTextColor + '"></icon></span><span id="end_chat_btn" title="Đánh giá chat" class="michat_options_btn" onclick="showOptions()" style="display:none;"></span></div>'), "slideside" == jsThemeConfig.triggerMethod && (chatMarkup_init = ultimate_chat_holder_slideside + ' data-module="2" >' + slideside_link_holder + '<span id="end_chat_btn" title="Đánh giá chat" class="michat_options_btn" onclick="showOptions()" style="display: none;"></span><div class="michat_shadow_eraser w_menu" style="background:' + jsThemeConfig.backgroundColor + '"></div><div id="michat_header_text" class="michat_header_text" style="' + slidesideTextMargin + "; color:" + jsThemeConfig.headerTextColor + '">' + jsThemeConfig.headerTextM2 + '</div><span class="header_image" id="header_image" style="' + slidesideHeaderMargin + '">' + addHeaderImages + "</span>");
    var chatHistoryVar = "";
    chatHistoryVar = "default" == jsThemeConfig.triggerMethod ? '<div class="' + jsThemeConfig.triggerMethod + '_chat_history_holder" id="chat_history_holder"><div class="' + jsThemeConfig.triggerMethod + '_chat_history" id="chat_history" style="background:' + jsThemeConfig.backgroundColor + '; color:white">' : '<div class="' + jsThemeConfig.triggerMethod + '_chat_history_holder"><div class="' + jsThemeConfig.triggerMethod + '_chat_history" id="chat_history">';
    var sound_status = "Sound on",
        sound_status_icon = "n";
    if ("off" != sessionStorage.getItem("michat_support-jsSession--widget_soundNotification")) {
        sound_status = "Sound off";
        var sound_status_icon = "o"
    }
    var scroll_type = "Auto";
    if ("manual" != sessionStorage.getItem("michat_support-jsSession--widget_scroll_type"))
        var scroll_type = "Manual";
    var chatMarkup = chatMarkup_init + chatHistoryVar + '<div class="a_reply"><span class="a_1"></span><span class="a_avatar_border"></span><span class="a_content_wrap"><span class="a_2"></span><span class="a_3"></span><span class="a_4"></span></span></div><div class="u_reply"><span class="u_1"></span><span class="u_avatar_border"></span><span class="u_content_wrap"><span class="u_2"></span><span class="u_3"></span><span class="u_4"></span></span></div></div></div><div id="usc_emoji_picker"></div><div id="michat_bottom_textarea_wrapper" style="bottom:25px;height:55px;background-color: ' + jsThemeConfig.textarea2BackgroundColor + '"><div style="height:100%;"><textarea id="usc_wysiwyg" class="michat_bottom_textarea"  placeholder="' + jsThemeConfig.m2PlaceholderTextMessage + '"></textarea></div><div id="footer-company">'+watermark_html+'</div><input name="user_ui"  type="hidden" id="user_ui" value="">' + 
        // '<button id="like_chat" class="emoji_btn_icon" style="display:none;color: ' + jsThemeConfig.widgetButtonColor + '"><i class="fa fa-thumbs-o-up"></i></button>' + 
        '<button class="emoji_btn_icon" ><i class="fa fa-paperclip" id="upfile1" style="color: ' + jsThemeConfig.widgetButtonColor + ';cursor:pointer;font-size:16px;margin-right:8px;"></i><input id="file_send" type="file" name="file_send" style="display:none;">' +
        '<button id="submit_reply" class="sendicon" style="color: ' + jsThemeConfig.widgetButtonColor + '"><icon data-icon="s" style=""></icon></button>' + '</div></div>' + buttonTriggerVar,
        message_init_front = "";
    "default" == jsThemeConfig.triggerMethod && (message_init_front = ultimate_chat_holder + ' data-module="3" >' + ultimate_chat_header + ultimate_chat_header_text + jsThemeConfig.headerTextM3 + '</span><span class="michat_close_holder" id="michat_close_holder" style="display:none;color:' + jsThemeConfig.headerTextColor + '"><icon class="' + jsThemeConfig.triggerMethod + '_chaticon_s" data-icon="b"></icon></span></div>'), "slideup" == jsThemeConfig.triggerMethod && (message_init_front = ultimate_chat_holder + ' data-module="3" >' + ultimate_chat_header + ultimate_chat_header_text + jsThemeConfig.headerTextM3 + '</span><span class="michat_link_holder" id="chat_link_holder"><icon class="' + jsThemeConfig.triggerMethod + '_chaticon" data-icon="e" style="color:' + jsThemeConfig.headerTextColor + '"></icon></span></div>'), "slideside" == jsThemeConfig.triggerMethod && (message_init_front = ultimate_chat_holder_slideside + ' data-module="3" >' + slideside_link_holder + slideside_shadow_eraser + slideside_header_text + jsThemeConfig.headerTextM3 + '<div class="michat_enter_username_spacer"></div>');
    var message_init = message_init_front + '<form id="send_msg_m3" method="post" style="height: 79%;overflow-y: auto;">\
                <div style="margin-right: 38px;margin-left: 38px;padding-bottom: 5px;margin-top: 22px;">\
                    <label style="font-size: 12px; font-weight: bold;color: #666666">Hiện giờ chúng tôi không ở đây, xin vui lòng để lại lời nhắn.</label>\
                </div>\
                <input type="text" class="michat_input" name="contact_name" id="contact_name" placeholder="' + jsThemeConfig.m3PlaceholderTextName + '" required/>';
                if(jsThemeConfig.requireEmail == 1){
                    message_init += '<input type="text" class="michat_input" name="contact_email" id="contact_email" placeholder="Email" required/>';
                }
                if(jsThemeConfig.requirePhone == 1){
                    message_init += '<input type="text" class="michat_input" name="contact_phone" id="contact_phone" onkeypress="return event.charCode >= 48 && event.charCode <= 57" maxlength = "11" placeholder="Số điện thoại" required/>';
                }
                message_init += '<div>\
                    <label style="margin-left: 40px;font-size: 12px; font-weight: bold;color: #666666">Hãy gửi tin nhắn cho chúng tôi về vấn đề của bạn :</label>\
                </div>\
                <textarea class="michat_textarea"  name="contact_message" id="contact_message" placeholder="' + jsThemeConfig.m3PlaceholderTextMessage + '" style="height: 80px !important;resize:none;" required></textarea>\
                <input type="submit" id="michat_button_offline" class="michat_button" value="' + jsThemeConfig.sendMailBtn + '" style="' + m3BtnBackground + " color:" + jsThemeConfig.sendMailBtnFontColor + '"/>\
            </form>\
            <div id="michat_bottom_textarea_wrapper" style="bottom:0px;background-color: ' + jsThemeConfig.textarea2BackgroundColor + ';border-bottom-left-radius: 8px;border-bottom-right-radius: 8px;">\
                <div style="height:100%;background-color:#fbfbfc;"></div>\
                <div id="footer-company">'+watermark_html+'</div>\
            </div>\
        </div>\
    </div>' + buttonTriggerVar;
    // socket.on('NOTI_USER_ONLINE', function(data) {
    //     _user_online_arr.push(data)
    // });
    // socket.on('NOTI_USER_OFFLINE', function(data) {
    //     _user_online_arr = _user_online_arr.filter(function(el) {
    //         return el.userId !== data.userId
    //     })
    // });
    if (null === sessionStorage.getItem("michat_support-jsSession--user_name")) {
        operatorsOnline > 0 ? (markup(), "1" == jsThemeConfig.requireAvatar && "img" == jsThemeConfig.userAvatarSelect && (document.getElementById("user_avatar_wrapper").style.display = "block", showAvatarSelect())) : "true" != jsGlobalConfig.offline_hide && messageInit()
    } else {
        if (operatorsOnline == 0) {
            "true" != jsGlobalConfig.offline_hide && messageInit()
        } else {
            chatInit(sessionStorage.getItem("michat_support-jsSession--user_name"), sessionStorage.getItem("michat_support-jsSession--request_id"))
        }
    }
    socketWidget();

    function auto_answer(time, content) {
        setTimeout(function() {
            $.ajax({
                url: 'https://demo-2021.midesk.vn/chat/checkAnswerAgent',
                type: "POST",
                dataType: 'json',
                async: !1,
                data: {
                    'Z3JvdXBpZA==': mi_group,
                    'dmlzaXRvcl9qaWQ=': 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-'),
                },
                success: function(data) {
                    if (data == 1) {
                        var agent_title = $('#agent-title span').text();
                        if (agent_title) {
                            setSlideUpToggle("open");
                            text_test = '<div class="a_reply theme2">\
                                <div style="color: #aaaaaa;margin-left: 50px;font-size: 11px;font-weight: bold;">' + agent_title + '</div>\
                                <span class="a_1 admin_avatar avatar_round" style="background-color: transparent;">\
                                    <img src="' + dataAvatarAgent + user_pic + '">\
                                </span>\
                                <span class="a_avatar_border"></span>\
                                <span class="a_content_wrap" style="background:' + jsThemeConfig.adminMessageColor + '">\
                                    <span class="a_2 admin_name">' + agent_title + '</span>\
                                    <span class="a_3 admin_time"></span>\
                                    <span class="a_4 admin_msg left_msg_bubble" style="">' + content + '</span>\
                                </span>\
                                <div class="a_reply_time">' + dateFormat(new Date(), "dd/mm/yy hh:MM TT") + '</div>\
                            </div>';
                            $('#chat_history').append(text_test);
                            Gab.scroll_chat()
                        }
                    }
                }
            })
        }, time)
    }

    function load_mess_agent(visitor_jid, from_jid) {
        $('.header-back').html('<span id="click_back"><img style="width:12px" src="https://mitek.midesk.vn/public/webchat/images/arrow.png"></span>');
        $('#usc_wysiwyg').css('display', 'block');
        $('#end_chat_btn').css('display', 'inline');
        var mess_text2 = '';
        $.ajax({
            url: 'https://demo-2021.midesk.vn/chat/chatClientHistory',
            type: "POST",
            dataType: 'json',
            async: !1,
            data: {
                'YWdlbnRfY2hhdF90b19hZ2VudA==': 'agent_chat_to_agent',
                'dG8=': "'" + visitor_jid.split('@')[0] + "'",
                'ZnJvbQ==': "'" + from_jid + "'",
                'Z3JvdXBpZA==': mi_group,
                'dmlzaXRvcl9qaWQ=': visitor_jid_queue,
            },
            success: function(data) {
                $.each(data[0], function(index, item) {
                    if(item.is_img == 1){
                        body = nl2br(item.body);
                    }else{
                        body = linkify(nl2br(item.body));
                    }
                    if (item.from == visitor_jid.split('@')[0]) {
                        visit_name = 'test visit';
                        if (item.body != 'Guest end chat.') {
                            mess_text2 = mess_text2 + '<div class="u_reply theme2">\
                                    <div style="color: #aaaaaa;font-size: 11px;font-weight: bold;">' + data[1] + '</div>\
                                    <span class="u_avatar_border"></span>\
                                    <span class="u_content_wrap" style="background:' + jsThemeConfig.userMessageColor + '">\
                                        <span class="u_2 user_name">' + visit_name + '</span>\
                                        <span class="u_3 user_time"></span>\
                                        <span class="u_4 user_msg right_msg_bubble" style="">' + body + '</span>\
                                    </span>\
                                    <span class="u_1 user_avatar avatar_round">\
                                        <img src="' + dataAvatarAgent + 'no_user_photo-v1.jpg">\
                                    </span>\
                                    <div class="u_reply_time">' + dateFormat(new Date(1000 * parseInt(item.datecreate)), "dd/mm/yy hh:MM TT") + '</div>\
                                </div>'
                        }
                    } else {
                        if (item.body.indexOf('kết thúc chat.') >= 0) {
                            mess_text2 = mess_text2 + '<div class="a_reply theme2" style="text-align:center;color: #1f8ceb;font-size: 12px;font-style: italic;">' + item.body + '</div>'
                        } else if (item.body.indexOf('chuyển chat.') >= 0) {
                            mess_text2 = mess_text2 + '<div class="a_reply theme2" style="text-align:center;color: #1f8ceb;font-size: 12px;font-style: italic;">' + item.body + '</div>'
                        } else {
                            if (item.picture != '') {
                                user_pic = item.picture
                            } else {
                                user_pic = 'no_user_photo-v1.jpg'
                            }
                            mess_text2 = mess_text2 + '<div class="a_reply theme2">\
                                    <div style="color: #aaaaaa;margin-left: 50px;font-size: 11px;font-weight: bold;">' + item.firstname + ' ' + item.lastname + '</div>\
                                    <span class="a_1 admin_avatar avatar_round" style="background-color: transparent;">\
                                        <img src="' + dataAvatarAgent + user_pic + '">\
                                    </span>\
                                    <span class="a_avatar_border"></span>\
                                    <span class="a_content_wrap" style="background:' + jsThemeConfig.adminMessageColor + '">\
                                        <span class="a_2 admin_name">' + item.firstname + ' ' + item.lastname + '</span>\
                                        <span class="a_3 admin_time"></span>\
                                        <span class="a_4 admin_msg left_msg_bubble" style="">' + body + '</span>\
                                    </span>\
                                    <div class="a_reply_time">' + dateFormat(new Date(1000 * parseInt(item.datecreate)), "dd/mm/yy hh:MM TT") + '</div>\
                                </div>'
                        }
                    }
                });
                $('#chat_history').html(mess_text2);
                Gab.scroll_chat()
            },
            beforeSend: function(data) {
                $('#chat_history').html($('#load-page_2'));
                $('#load-page_2').css('display', 'block')
            },
            complete: function(data) {
                $('#load-page_2').css('display', 'none')
            }
        })
    }

    function change_time() {
        console.log($('.u_reply_time').attr("data-time"))
    }

    function chat() {
        var current_time = new Date();
        $.ajax({
            url: 'https://demo-2021.midesk.vn/chat/agentAssign',
            type: "POST",
            dataType: 'json',
            data: {
                'Y2hlY2tfYWdlbnRfYXNzaWdu': 'check_agent_assign',
                'dmlzaXRvcl9qaWRfcXVldWU=': visitor_jid_queue.split('@')[0],
                'Z3JvdXBpZA==': mi_group,
                'aG9zdF9uYW1l': jsGetVars.host_name,
                'Ym9keQ==': linkify(nl2br(encodeHTML($('#usc_wysiwyg').val()))),
            },
            success: function(data) {
                console.log('====');
                $.ajax({
                    url: 'https://demo-2021.midesk.vn/chat/checkTimeWork',
                    type: "POST",
                    async: !1,
                    data: {
                        'groupid': mi_group,
                        'id_chat': 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-'),
                        'host_name': jsGetVars.host_name,
                        'url_visit': jsGetVars.current_url,
                        'date': new Date().getDate(),
                    },
                    success: function(data) {
                        if(data == 0){
                            alert('Tư vấn hiện offline. Vui lòng để lại lời nhắn.');
                            location.reload();
                        }
                    }
                });
                
                if(data.message == 'AGENT_OFFLINE'){
                    alert('Tư vấn hiện offline. Vui lòng để lại lời nhắn.');
                    location.reload();
                }else{
                    agent_jid = data[0].jid;
                    sessionStorage.setItem("michat_support-jsSession--agent_jid", agent_jid);
                    getMonitor();
                    var body = encodeHTML($('#usc_wysiwyg').val());
                    var message = $msg({
                        to: agent_jid,
                        "type": "chat"
                    }).c('body').t(linkify(nl2br(body))).up().c('active', {
                        xmlns: "http://jabber.org/protocol/chatstates"
                    }).c('rand').t(Math.random().toString(36).substr(2, 5));
                    Gab.connection.send(message);
                    if (body != '') {
                        $('#chat_history').append('<div class="u_reply theme2">\
                                <div style="color: #aaaaaa;font-size: 11px;font-weight: bold;">' + data[1].name + '</div>\
                                <span class="u_avatar_border"></span>\
                                <span class="u_content_wrap" style="background:' + jsThemeConfig.userMessageColor + '">\
                                    <span class="u_2 user_name">' + data[1].name + '</span>\
                                    <span class="u_3 user_time"></span>\
                                    <span class="u_4 user_msg right_msg_bubble" style="">' + linkify(nl2br(body)) + '</span>\
                                </span>\
                                <span class="u_1 user_avatar avatar_round">\
                                    <img src="' + dataAvatarAgent + 'no_user_photo-v1.jpg">\
                                </span>\
                                <div class="u_reply_time" data-time="' + current_time + '">' + dateFormat(new Date(), "dd/mm/yy hh:MM TT") + '</div>\
                            </div>');
                        $.ajax({
                            url: 'https://demo-2021.midesk.vn/chat/messageChat',
                            type: "POST",
                            async: !1,
                            data: {
                                'YWRkX21lc3NhZ2VfYXJjaGl2ZQ==': 'add_message_archive',
                                'Z3JvdXBpZA==': mi_group,
                                'bmFtZQ==': data[1].name,
                                'dmlzaXRvcl9qaWQ=': data[1].id_channel,
                                'ZnJvbQ==': (data[1].id_channel).split('@')[0],
                                'dG8=': data[0].user_id,
                                'YWdlbnRfYXNzaWdu': data[0].user_id,
                                'Ym9keQ==': linkify(nl2br(body)),
                                'cmVwbHk=': 0,
                            },
                            success: function(data) {}
                        });
                        Gab.scroll_chat()
                    }
                    $('#usc_wysiwyg').val('')
                }
                
            }
        })
    }

    function load_mess_current(type = '') {
        $('.header-back').html('<span id="click_back"><img style="width:12px" src="https://mitek.midesk.vn/public/webchat/images/arrow.png"></span>');
        var text_test3 = '';
        $('#usc_wysiwyg').css('display', 'block');
        $.ajax({
            url: 'https://demo-2021.midesk.vn/chat/clientHistory',
            type: "POST",
            dataType: 'json',
            async: !1,
            data: {
                'dmlzaXRvcl9qaWQ=': visitor_jid_queue.split('@')[0],
                'Z3JvdXBpZA==': mi_group,
            },
            success: function(data) {
                $.each(data[0], function(index, item) {
                    if(item.is_img == 1){
                        body = nl2br(item.body);
                    }else{
                        body = linkify(nl2br(item.body));
                    }
                    if (item.from == visitor_jid_queue.split('@')[0]) {
                        visit_name = data[1].name;
                        if (item.body != 'Guest end chat.') {
                            text_test3 = text_test3 + '<div class="u_reply theme2">\
                            <div style="color: #aaaaaa;font-size: 11px;font-weight: bold;">' + visit_name + '</div>\
                            <span class="u_avatar_border"></span>\
                            <span class="u_content_wrap" style="background:' + jsThemeConfig.userMessageColor + '">\
                                <span class="u_2 user_name">' + visit_name + '</span>\
                                <span class="u_3 user_time"></span>\
                                <span class="u_4 user_msg right_msg_bubble" style="">' + body + '</span>\
                            </span>\
                            <span class="u_1 user_avatar avatar_round">\
                                <img src="' + dataAvatarAgent + 'no_user_photo-v1.jpg">\
                            </span>\
                            <div class="u_reply_time">' + dateFormat(new Date(1000 * parseInt(item.datecreate)), "dd/mm/yy hh:MM TT") + '</div>\
                        </div>'
                        }
                    } else {
                        if (item.body.indexOf('kết thúc chat.') >= 0) {
                            text_test3 = text_test3 + '<div class="a_reply theme2" style="text-align:center;color: #1f8ceb;font-size: 12px;font-style: italic;">' + item.body + '</div>'
                        } else if (item.body.indexOf('chuyển chat.') >= 0) {
                            text_test3 = text_test3 + '<div class="a_reply theme2" style="text-align:center;color: #1f8ceb;font-size: 12px;font-style: italic;">' + item.body + '</div>'
                        } else {
                            if (item.picture != '') {
                                user_pic = item.picture
                            } else {
                                user_pic = 'no_user_photo-v1.jpg'
                            }
                            text_test3 = text_test3 + '<div class="a_reply theme2">\
                            <div style="color: #aaaaaa;margin-left: 50px;font-size: 11px;font-weight: bold;">' + item.firstname + ' ' + item.lastname + '</div>\
                            <span class="a_1 admin_avatar avatar_round" style="background-color: transparent;">\
                                <img src="' + dataAvatarAgent + user_pic + '">\
                            </span>\
                            <span class="a_avatar_border"></span>\
                            <span class="a_content_wrap" style="background:' + jsThemeConfig.adminMessageColor + '">\
                                <span class="a_2 admin_name">' + item.firstname + ' ' + item.lastname + '</span>\
                                <span class="a_3 admin_time"></span>\
                                <span class="a_4 admin_msg left_msg_bubble" style="">' + body + '</span>\
                            </span>\
                            <div class="a_reply_time">' + dateFormat(new Date(1000 * parseInt(item.datecreate)), "dd/mm/yy hh:MM TT") + '</div>\
                        </div>'
                        }
                    }
                })
                if(data[2] == 0){
		        	if (type == 'new_queue') {
			            text_test3 = text_test3 + '<div class="a_reply theme2">\
			                    <span class="a_1 admin_avatar avatar_round" style="background-color: transparent;">\
			                        <img src="' + dataAvatarAgent + user_pic + '">\
			                    </span>\
			                    <span class="a_avatar_border"></span>\
			                    <span class="a_content_wrap" style="margin-bottom: 5px;background:' + jsThemeConfig.adminMessageColor + '">\
			                        <span class="a_3 admin_time"></span>\
			                        <span class="a_4 admin_msg left_msg_bubble" style="">' + jsThemeConfig.initMsgModule_2 + '</span>\
			                    </span>\
			                    <div class="a_reply_time"></div>\
			                </div>'
			        } else {
			            text_test3 = text_test3 + '<div class="a_reply theme2">\
			                    <div style="color: #aaaaaa;margin-left: 50px;font-size: 11px;font-weight: bold;">' + $('#agent-title').text() + '</div>\
			                    <span class="a_1 admin_avatar avatar_round" style="background-color: transparent;">\
			                        <img src="' + $('#agent-avatar-header').attr('src') + '">\
			                    </span>\
			                    <span class="a_avatar_border"></span>\
			                    <span class="a_content_wrap" style="margin-bottom: 5px;background:' + jsThemeConfig.adminMessageColor + '">\
			                        <span class="a_3 admin_time"></span>\
			                        <span class="a_4 admin_msg left_msg_bubble" style="">' + (jsThemeConfig.initMsgModule_2).replace("%name", $('#agent-title').text()) + '</span>\
			                    </span>\
			                    <div class="a_reply_time"></div>\
			                </div>'
			        }
		        }
		        
		        $('#chat_history').html(text_test3);
		        Gab.scroll_chat()
            }
        });
    }
    var dateFormat = function() {
        var token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,
            timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,
            timezoneClip = /[^-+\dA-Z]/g,
            pad = function(val, len) {
                val = String(val);
                len = len || 2;
                while (val.length < len) val = "0" + val;
                return val
            };
        return function(date, mask, utc) {
            var dF = dateFormat;
            if (arguments.length == 1 && Object.prototype.toString.call(date) == "[object String]" && !/\d/.test(date)) {
                mask = date;
                date = undefined
            }
            date = date ? new Date(date) : new Date;
            mask = String(dF.masks[mask] || mask || dF.masks["default"]);
            if (mask.slice(0, 4) == "UTC:") {
                mask = mask.slice(4);
                utc = !0
            }
            var _ = utc ? "getUTC" : "get",
                d = date[_ + "Date"](),
                D = date[_ + "Day"](),
                m = date[_ + "Month"](),
                y = date[_ + "FullYear"](),
                H = date[_ + "Hours"](),
                M = date[_ + "Minutes"](),
                s = date[_ + "Seconds"](),
                L = date[_ + "Milliseconds"](),
                o = utc ? 0 : date.getTimezoneOffset(),
                flags = {
                    d: d,
                    dd: pad(d),
                    ddd: dF.i18n.dayNames[D],
                    dddd: dF.i18n.dayNames[D + 7],
                    m: m + 1,
                    mm: pad(m + 1),
                    mmm: dF.i18n.monthNames[m],
                    mmmm: dF.i18n.monthNames[m + 12],
                    yy: String(y).slice(2),
                    yyyy: y,
                    h: H % 12 || 12,
                    hh: pad(H % 12 || 12),
                    H: H,
                    HH: pad(H),
                    M: M,
                    MM: pad(M),
                    s: s,
                    ss: pad(s),
                    l: pad(L, 3),
                    L: pad(L > 99 ? Math.round(L / 10) : L),
                    t: H < 12 ? "a" : "p",
                    tt: H < 12 ? "am" : "pm",
                    T: H < 12 ? "A" : "P",
                    TT: H < 12 ? "AM" : "PM",
                    Z: utc ? "UTC" : (String(date).match(timezone) || [""]).pop().replace(timezoneClip, ""),
                    o: (o > 0 ? "-" : "+") + pad(Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o) % 60, 4),
                    S: ["th", "st", "nd", "rd"][d % 10 > 3 ? 0 : (d % 100 - d % 10 != 10) * d % 10]
                };
            return mask.replace(token, function($0) {
                return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1)
            })
        }
    }();
    dateFormat.masks = {
        "default": "ddd mmm dd yyyy HH:MM:ss",
        shortDate: "m/d/yy",
        mediumDate: "mmm d, yyyy",
        longDate: "mmmm d, yyyy",
        fullDate: "dddd, mmmm d, yyyy",
        shortTime: "h:MM TT",
        mediumTime: "h:MM:ss TT",
        longTime: "h:MM:ss TT Z",
        isoDate: "yyyy-mm-dd",
        isoTime: "HH:MM:ss",
        isoDateTime: "yyyy-mm-dd'T'HH:MM:ss",
        isoUtcDateTime: "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
    };
    dateFormat.i18n = {
        dayNames: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
        monthNames: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
    };
    Date.prototype.format = function(mask, utc) {
        return dateFormat(this, mask, utc)
    };
    var timeSince2 = function(date) {
        var seconds = Math.floor((new Date() - date) / 1000);
        var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        if (seconds < 60) {
            return "Ngay bây giờ"
        } else if (seconds <= 3600) {
            minutes = Math.floor(seconds / 60)
            return minutes + " phút trước"
        } else if (seconds > 3600 && seconds < 86400) {
            hours = Math.floor(seconds / 3600)
            return hours + " giờ trước"
        } else {
            return date.getDate().toString() + " " + months[date.getMonth()] + ", " + date.getFullYear()
        }
    }
    String.prototype.trunc = String.prototype.trunc || function(n) {
        return (this.length > n) ? this.substr(0, n - 1) + '&hellip;' : this
    };
    var username_xmpp;
    var email_xmpp;
    var phone_xmpp;
    var support_type;

    $(document).on('click', '#upfile1', function () {
        $("#file_send").trigger('click');
    });

    $(document).on('change', '#file_send', function() {
      // var file_data = $("#file_send").attr("files")[0]; 
        var current_time = new Date();
        var form_data = new FormData();
        form_data.append("file", $('#file_send')[0].files[0]);
        form_data.append("groupid", mi_group);
        $.ajax({
            url: "https://demo-2021.midesk.vn/chat/uploadFile",
            type: 'POST',
            data: form_data,
            // dataType: 'json',
            // async: false,
            cache: false,
            contentType: false,
            processData: false,
        
            success: function(data) {
                data = JSON.parse(data);
                if(data.status == 'true'){
                    if(data.extension == 'gif' || data.extension == 'png' || data.extension == 'jpg'){
                        var link_file_name = '<img src="'+data.link_file_name+'" style="max-width:200px;max-height:200px;">';
                    }else{
                        var link_file_name = '<a href="'+data.link_file_name+'" target="_blank">'+data.file_name+'</a>';
                    }
                    $.ajax({
                        url: 'https://demo-2021.midesk.vn/chat/agentAssign',
                        type: "POST",
                        dataType: 'json',
                        data: {
                            'Y2hlY2tfYWdlbnRfYXNzaWdu': 'check_agent_assign',
                            'dmlzaXRvcl9qaWRfcXVldWU=': visitor_jid_queue.split('@')[0],
                            'Z3JvdXBpZA==': mi_group,
                            'aG9zdF9uYW1l': jsGetVars.host_name,
                        },
                        success: function(data) {
                            if(data.message == 'AGENT_OFFLINE'){
                                alert('Tư vấn hiện offline. Vui lòng để lại lời nhắn.');
                                location.reload();
                            }else{
                                agent_jid = data[0].jid;
                                sessionStorage.setItem("michat_support-jsSession--agent_jid", agent_jid);
                                getMonitor();
                                var body = link_file_name;
                                var message = $msg({
                                    to: agent_jid,
                                    "type": "chat"
                                }).c('body').t(nl2br(body)).up().c('active', {
                                    xmlns: "http://jabber.org/protocol/chatstates"
                                }).c('rand').t(Math.random().toString(36).substr(2, 5));
                                Gab.connection.send(message);
                                if (body != '') {
                                    $('#chat_history').append('<div class="u_reply theme2">\
                                            <div style="color: #aaaaaa;font-size: 11px;font-weight: bold;">' + data[1].name + '</div>\
                                            <span class="u_avatar_border"></span>\
                                            <span class="u_content_wrap" style="background:' + jsThemeConfig.userMessageColor + '">\
                                                <span class="u_2 user_name">' + data[1].name + '</span>\
                                                <span class="u_3 user_time"></span>\
                                                <span class="u_4 user_msg right_msg_bubble" style="">' + nl2br(body) + '</span>\
                                            </span>\
                                            <span class="u_1 user_avatar avatar_round">\
                                                <img src="' + dataAvatarAgent + 'no_user_photo-v1.jpg">\
                                            </span>\
                                            <div class="u_reply_time" data-time="' + current_time + '">' + dateFormat(new Date(), "dd/mm/yy hh:MM TT") + '</div>\
                                        </div>');
                                    $.ajax({
                                        url: 'https://demo-2021.midesk.vn/chat/messageChat',
                                        type: "POST",
                                        async: !1,
                                        data: {
                                            'YWRkX21lc3NhZ2VfYXJjaGl2ZQ==': 'add_message_archive',
                                            'Z3JvdXBpZA==': mi_group,
                                            'bmFtZQ==': data[1].name,
                                            'dmlzaXRvcl9qaWQ=': data[1].id_channel,
                                            'ZnJvbQ==': (data[1].id_channel).split('@')[0],
                                            'dG8=': data[0].user_id,
                                            'YWdlbnRfYXNzaWdu': data[0].user_id,
                                            'Ym9keQ==': body,
                                            'cmVwbHk=': 0,
                                            'aXNfaW1n': 1,
                                        },
                                        success: function(data) {}
                                    });
                                    Gab.scroll_chat()
                                }
                                $('#usc_wysiwyg').val('')
                            }
                            
                        }
                    })


                }else{
                    alert('Upload không thành công.');
                }
            }
        });
    });

    $(document).ready(function() {

        // $.ajax({
        //     url: 'https://demo-2021.midesk.vn/chat/visitorPage',
        //     type: "POST",
        //     dataType: 'json',
        //     async: !1,
        //     data: {
        //         'Z3JvdXBpZA==': mi_group,
        //         'Y29va2llX2lk': localStorage.getItem("michat_support-jsCookie"),
        //         'c2Vzc2lvbl9pZA==': sessionStorage.getItem("michat_support-jsSession"),
        //         'dGl0bGU=': jsGetVars.title_web,
        //         'cGFnZV92aXNpdA==': jsGetVars.current_url,
        //         'dmlzaXRvcl9qaWQ=': 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-'),
        //         'aG9zdF9uYW1l': jsGetVars.host_name,
        //     },
        //     success: function(data) {
        //         if (data.status == !0) {
        //             auto_answer(data.auto_answer_time, data.auto_answer_content)
        //         }
        //     }
        // });
        // setTimeout(function() {}, 20000);
        // setTimeout(function() {
            // socket.emit('REQUEST_VISIT_IN_GROUP', {
            //     groupid: mi_group
            // })
        // }, 3000);
        if (sessionStorage.getItem("michat_support-jsSession") != null) {}
        void 0 != document.getElementById("michat_close_btn") && (document.getElementById("michat_close_btn").style.display = "none")
        void 0 != document.getElementById("michat_start_btn") && (document.getElementById("michat_start_btn").style.display = "block"), setSlideUpToggle("closed"), window.addEventListener && ("wide" != sessionStorage.getItem("michat_support-jsSession--widgetWidthMode") ? parent.postMessage({
            task: "iframe_init_" + jsThemeConfig.triggerMethod
        }, target_origin) : parent.postMessage({
            task: "iframe_wide"
        }, target_origin))
        var cookie_data = {
            jid: $.cookie('xmpp_jid'),
            sid: $.cookie('xmpp_sid'),
            rid: $.cookie('xmpp_rid')
        };
        if (cookie_data.jid != hostname_xmpp && cookie_data.sid && cookie_data.rid) {
            var connection = new Strophe.Connection(link_xmpp, {'keepalive': true});
            var callback = function(status) {
                if (status === Strophe.Status.REGISTER) {
                    connection.register.fields.username = 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-');
                    connection.register.fields.password = hash;
                    connection.register.fields.name = 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-');
                    connection.register.submit()
                } else if (status === Strophe.Status.REGISTERED) {
                    connection.register.authenticate()
                } else if (status === Strophe.Status.CONFLICT) {} else if (status === Strophe.Status.NOTACCEPTABLE) {} else if (status === Strophe.Status.REGIFAIL) {} else if (status === Strophe.Status.CONNECTED) {} else if (status === Strophe.Status.ATTACHED) {
                    console.log('Strophe is attached.' + status)
                } else {}
            };
            connection.register.connect(hostname_xmpp, callback, 60, 1);
            // $(document).trigger('attach', cookie_data)
            $(document).trigger('connect')
        } else {
            console.log('dang ky');
            var callback = function(status) {
                if (status === Strophe.Status.REGISTER) {
                    connection.register.fields.username = 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-');
                    connection.register.fields.password = hash;
                    connection.register.fields.name = 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-');
                    connection.register.submit()
                } else if (status === Strophe.Status.REGISTERED) {
                    connection.register.authenticate()
                } else if (status === Strophe.Status.CONFLICT) {

                } else if (status === Strophe.Status.NOTACCEPTABLE) {

                } else if (status === Strophe.Status.REGIFAIL) {
                    console.log(status);
                    location.reload();
                } else if (status === Strophe.Status.CONNECTED) {

                } else {

                }
            };
            var connection = new Strophe.Connection(link_xmpp, {'keepalive': true});
            connection.register.connect(hostname_xmpp, callback, 60, 1)
            $(document).trigger('connect')
        }
        $(document).on('click', '#end_chat_btn', function() {
            $('#end_chat_btn').hide();
            $('#usc_wysiwyg').hide();
            _message_archive = $('#chat_history').html();
            $('#chat_history').html('<div>\
                    <label id="lbl-close-chat" style="font-weight:bold;">Vui lòng đánh giá chat hiện tại (*)</label>\
                    <ul id="icon-rate">\
                        <li id="verygood"><img src="https://demo-2021.midesk.vn/public/webchat/images/heart.png"><label>Rất hài lòng</label></li>\
                        <li id="like"><img src="https://demo-2021.midesk.vn/public/webchat/images/like2.png"><label>Hài lòng</label></li>\
                        <li id="dislike"><img src="https://demo-2021.midesk.vn/public/webchat/images/dislike2.png"><label>Không hài lòng</label></li>\
                    </ul>\
                </div>\
                <div>\
                    <label id="lbl-close-chat" style="font-weight:bold;">Vui lòng để lại nhận xét (*)</label>\
                </div>\
                <div>\
                    <textarea id="comment-rate" rows="6" placeholder="Nhận xét của bạn"></textarea>\
                </div>\
                <div>\
                    <div>\
                        <table id="tbl-close-chat" width="100%">\
                            <tr>\
                                <td id="close-chat-div" width="100px">Kết thúc chat</td>\
                                <td id="cancel-chat-div" width="100px">Bỏ qua</td>\
                            </tr>\
                        </table>\
                    </div>\
                </div>')
        });
        like_rate = '';
        $(document).on('click', '#icon-rate li', function() {
            $("#icon-rate li.rate-choose").removeClass("rate-choose");
            $(this).addClass('rate-choose');
            like_rate = this.id
        });
        $(document).on('click', '#close-chat-div', function() {
            if (like_rate == '' || $('#comment-rate').val() == '') {
                alert('Vui lòng đánh giá trước khi kết thúc chat.')
            } else {
                var message = $msg({
                    to: sessionStorage.getItem("michat_support-jsSession--agent_jid"),
                    "type": "chat"
                }).c('body').t('Guest end chat.').up().c('active', {
                    xmlns: "http://jabber.org/protocol/chatstates"
                });
                Gab.connection.send(message);
                if (!sessionStorage.getItem("michat_support-jsSession--agent_jid")) {
                    $.ajax({
                        url: 'https://demo-2021.midesk.vn/chat/agentAssign',
                        type: "POST",
                        dataType: 'json',
                        async: !1,
                        data: {
                            'Y2hlY2tfYWdlbnRfYXNzaWdu': 'check_agent_assign',
                            'dmlzaXRvcl9qaWRfcXVldWU=': visitor_jid_queue,
                            'Z3JvdXBpZA==': mi_group,
                            'aG9zdF9uYW1l': jsGetVars.host_name,
                        },
                        success: function(data) {
                            if(data.message == 'AGENT_OFFLINE'){
                                alert('Tư vấn hiện offline. Vui lòng để lại lời nhắn.');
                                location.reload();
                            }else{
                                sessionStorage.setItem("michat_support-jsSession--agent_jid", data[0].jid);
                                getMonitor()
                            }
                            
                        }
                    })
                }
                $.ajax({
                    url: 'https://demo-2021.midesk.vn/chat/addCommentRate',
                    type: "POST",
                    data: {
                        'YWRkX2NvbW1lbnRfcmF0ZQ==': 'add_comment_rate',
                        'Z3JvdXBpZA==': mi_group,
                        'dmlzaXRvcl9qaWQ=': visitor_jid_queue,
                        'YWdlbnRfYXNzaWdu': agent_assign,
                        'bGlrZV9yYXRl': like_rate,
                        'Y29tbWVudF9yYXRl': $('#comment-rate').val(),
                    },
                    success: function(data) {}
                });
                $.ajax({
                    url: 'https://demo-2021.midesk.vn/chat/messageChat',
                    type: "POST",
                    async: !1,
                    data: {
                        'YWRkX21lc3NhZ2VfYXJjaGl2ZQ==': 'add_message_archive',
                        'Z3JvdXBpZA==': mi_group,
                        'bmFtZQ==': '',
                        'dmlzaXRvcl9qaWQ=': visitor_jid_queue,
                        'ZnJvbQ==': visitor_jid_queue.split('@')[0],
                        'dG8=': agent_assign,
                        'YWdlbnRfYXNzaWdu': agent_assign,
                        'Ym9keQ==': 'Guest end chat.',
                        'cmVwbHk=': 2,
                    },
                    success: function(data) {
                        $.ajax({
                            url: 'https://demo-2021.midesk.vn/ES_chat/clientEndChat',
                            type: "POST",
                            data: {
                                'Y2xpZW50X2VuZF9jaGF0': 'client_end_chat',
                                'Z3JvdXBpZA==': mi_group,
                                'dmlzaXRvcl9qaWQ=': visitor_jid_queue,
                                'YWdlbnRfYXNzaWdu': agent_assign,
                            },
                            success: function(data) {
                                location.reload()
                            },
                            beforeSend: function(data) {
                                $('#chat_history').html($('#load-page_2'));
                                $('#load-page_2').css('display', 'block')
                            },
                            complete: function(data) {
                                $('#load-page_2').css('display', 'none')
                            }
                        })
                    }
                })
            }
        });
        $(document).on('click', '#cancel-chat-div', function() {
            $('#chat_history').html(_message_archive);
            $('#end_chat_btn').show();
            $('#usc_wysiwyg').show()
        });
        $(document).on('click', '#like_chat', function() {
            $('#like_chat').addClass('active_class');
            $('#unlike_chat').removeClass('active_class');
            var text_test = '';
            text_test = '<div class="a_reply theme2" style="text-align:center;color: #1f8ceb;font-size: 12px;font-style: italic;">Bạn thích cuộc trò chuyện này<div class="u_reply_time">' + dateFormat(new Date(), "dd/mm/yy hh:MM TT") + '</div></div>';
            $('#chat_history').append(text_test);
            Gab.scroll_chat();
            $.ajax({
                url: 'https://demo-2021.midesk.vn/chat/addCommentRate',
                type: "POST",
                data: {
                    'YWRkX2NvbW1lbnRfcmF0ZQ==': 'add_comment_rate',
                    'Z3JvdXBpZA==': mi_group,
                    'dmlzaXRvcl9qaWQ=': visitor_jid_queue,
                    'YWdlbnRfYXNzaWdu': agent_assign,
                    'bGlrZV9yYXRl': 'like',
                    'Y29tbWVudF9yYXRl': '',
                },
                success: function(data) {}
            })
        });
        $(document).on('click', '#unlike_chat', function() {
            $('#like_chat').removeClass('active_class');
            $('#unlike_chat').addClass('active_class');
            var text_test = '';
            text_test = '<div class="a_reply theme2" style="text-align:center;color: #1f8ceb;font-size: 12px;font-style: italic;">Bạn không thích cuộc trò chuyện này<div class="u_reply_time">' + dateFormat(new Date(), "dd/mm/yy hh:MM TT") + '</div></div>';
            $('#chat_history').append(text_test);
            Gab.scroll_chat();
            $.ajax({
                url: 'https://demo-2021.midesk.vn/chat/addCommentRate',
                type: "POST",
                data: {
                    'YWRkX2NvbW1lbnRfcmF0ZQ==': 'add_comment_rate',
                    'Z3JvdXBpZA==': mi_group,
                    'dmlzaXRvcl9qaWQ=': visitor_jid_queue,
                    'YWdlbnRfYXNzaWdu': agent_assign,
                    'bGlrZV9yYXRl': 'dislike',
                    'Y29tbWVudF9yYXRl': '',
                },
                success: function(data) {}
            })
        });
        $(document).on('keypress', '#usc_wysiwyg', function(event) {
            if (event.keyCode == 13 && !event.shiftKey) {
                chat();
                $(this).parent().data('composing', !1);
                return !1
            } else {
                var composing = $(this).parent().data('composing');
                if (!composing) {
                    var notify = $msg({
                        to: sessionStorage.getItem("michat_support-jsSession--agent_jid"),
                        "type": "chat"
                    }).c('composing', {
                        xmlns: "http://jabber.org/protocol/chatstates"
                    });
                    Gab.connection.send(notify);
                    $(this).parent().data('composing', !0)
                }
            }
        });
        $(document).on('click', '#submit_reply', function() {
            chat();
            $(this).parent().data('composing', !1)
        });
        $(document).on('click', '#click_current', function() {
            $('.header-back').html('<span id="click_back"><img style="width:12px" src="https://mitek.midesk.vn/public/webchat/images/arrow.png"></span>');
            load_mess_current()
        });
        $(document).on('click', '#click_back', function() {
            $('.header-back').html('<span id="click_current"><img style="width:12px" src="https://mitek.midesk.vn/public/webchat/images/arrow.png"></span>');
            $('#end_chat_btn').show();
            $('#usc_wysiwyg').css('display', 'none');
            var list_agent_history;
            _message_archive = $('#chat_history').html();
            list_agent_history = '<div id="agent-list-div" style="width:100%">\
                                    <div id="agent-assign-ele" onclick="load_mess_current()">\
                                        <img id="agent-assign-img-ele" src="' + dataAvatarAgent + 'no_user_photo-v1.jpg">\
                                        <span id="agent-name-ele">Tiếp tục chat hiện tại</span>\
                                        <span id="time-ele"></span>\
                                    </div>';
            $.ajax({
                url: 'https://demo-2021.midesk.vn/chat/listAgent',
                type: "POST",
                dataType: 'json',
                async: !1,
                data: {
                    'YWdlbnRfYXNzaWduX2xpc3RfY2hhdA==': 'agent_assign_list_chat',
                    'dmlzaXRvcl9qaWQ=': visitor_jid_queue.split('@')[0],
                    'ZnJvbQ==': visitor_jid_queue.split('@')[0],
                    'Z3JvdXBpZA==': mi_group,
                },
                success: function(data) {
                    $.each(data, function(index, item) {
                        if (item.picture != '') {
                            user_pic = item.picture
                        } else {
                            user_pic = 'no_user_photo-v1.jpg'
                        }
                        list_agent_history = list_agent_history + '<div id="agent-assign-ele" onclick="load_mess_agent(' + "'" + item.visitor_jid + "'" + ',' + "'" + item.from + "'" + ')">\
                            <span style="display: block;float: left;"><img id="agent-assign-img-ele" src="' + dataAvatarAgent + user_pic + '"></span>\
                            <span style="display:inline-block;">\
                                <div id="agent-name-ele">' + item.firstname + ' ' + item.lastname + '</div>\
                                <div id="agent-mess-ele">' + item.firstname + ' ' + item.lastname + ': ' + item.body.trunc(15) + '</div>\
                            </span>\
                            <span id="time-ele">' + dateFormat(new Date(1000 * parseInt(item.datecreate)), "dd/mm/yy hh:MM TT") + '</span>\
                        </div>'
                    })
                },
                beforeSend: function(data) {
                    $('#chat_history').html($('#load-page_2'));
                    $('#load-page_2').css('display', 'block')
                },
                complete: function(data) {
                    $('#load-page_2').css('display', 'none')
                }
            });
            list_agent_history = list_agent_history + '</div>';
            $('#chat_history').html(list_agent_history)
        });
        $(document).on('click', '#click_down', function() {
            void 0 != document.getElementById("michat_close_btn") && (document.getElementById("michat_close_btn").style.display = "none")
            void 0 != document.getElementById("michat_start_btn") && (document.getElementById("michat_start_btn").style.display = "block"), setSlideUpToggle("closed"), window.addEventListener && ("wide" != sessionStorage.getItem("michat_support-jsSession--widgetWidthMode") ? parent.postMessage({
                task: "iframe_init_" + jsThemeConfig.triggerMethod
            }, target_origin) : parent.postMessage({
                task: "iframe_wide"
            }, target_origin))
        });
        $(document).on('click', '#michat_button_online', function() {
            _start_chat_flag = !0;
            if ($('#username').val() != '') {

                if(!validateName($('#username').val())){
                    alert('Tên không được chứa ký tự đặc biệt');
                    return false;
                }

                if ($('#useremail').val() && !validateEmail($('#useremail').val())) {
                    alert('Vui lòng nhập đúng định dạng Email');
                    return false;
                }

                if ($('#phone').val() && isNaN($('#phone').val()) == true) {
                    alert('Vui lòng nhập đúng định dạng điện thoại');
                    return false;
                }

                if ($('#phone').val().length > 11 || $('#phone').val().length < 9) {
                    alert('Vui lòng nhập đúng định dạng điện thoại');
                    return false;
                }

                localStorage.setItem("michat_support-nameClient", $('#username').val());
                localStorage.setItem("michat_support-emailClient", $('#useremail').val());
                localStorage.setItem("michat_support-phoneClient", $('#phone').val());
                if ((jsThemeConfig.requirePhone == 1 && $('#phone').val() && jsThemeConfig.requireEmail == 0 && $('select[name=support_type]').val()) || (jsThemeConfig.requireEmail == 1 && $('#useremail').val() && jsThemeConfig.requirePhone == 0 && $('select[name=support_type]').val()) || jsThemeConfig.requirePhone == 1 && jsThemeConfig.requireEmail == 1 && $('#phone').val() && $('#useremail').val() && $('select[name=support_type]').val()) {}

				parent.postMessage('MICHAT_BUTTON_ONLINE', '*');

                $.ajax({
                    url: 'https://demo-2021.midesk.vn/chat/updateNameVisitors',
                    type: "POST",
                    data: {
                        'dXBkYXRlX25hbWVfdmlzaXRvcnM=': 'update_name_visitors',
                        'Z3JvdXBpZA==': mi_group,
                        'c2Vzc2lvbl92aXNpdA==': sessionStorage.getItem("michat_support-jsSession"),
                        'Y29va2llX3Zpc2l0': localStorage.getItem("michat_support-jsCookie"),
                        'aG9zdF9uYW1l': jsGetVars.host_name,
                        'bmFtZV92aXNpdA==': $('#username').val(),
                        'ZW1haWxfdmlzaXQ=': $('#useremail').val(),
                        'cGhvbmVfdmlzaXQ=': $('#phone').val(),
                        'c3VwcG9ydF90eXBlX2lk': $('select[name=support_type]').val(),
                    },
                    success: function(data) {}
                });
                username_xmpp = $('#username').val();
                email_xmpp = $('#useremail').val();
                phone_xmpp = $('#phone').val();
                support_type = $('select[name=support_type]').val()
            }
        });
        $(document).on('click', '#michat_button_offline', function() {
            if ($('#contact_name').val() != '' && $('#contact_message').val() != '') {

                if(!validateName($('#contact_name').val())){
                    alert('Tên không được chứa ký tự đặc biệt');
                    return false;
                }

                if ($('#contact_email').val() && !validateEmail($('#contact_email').val())) {
                    alert('Vui lòng nhập đúng định dạng Email');
                    return false;
                }

                if ($('#contact_phone').val() && isNaN($('#contact_phone').val()) == true) {
                    alert('Vui lòng nhập đúng định dạng điện thoại');
                    return false;
                }

                parent.postMessage('MICHAT_BUTTON_OFFLINE', '*');
                // $('#send_msg_m3').html('111');

                $.ajax({
                    url: 'https://demo-2021.midesk.vn/chat/messageOffline',
                    type: "POST",
                    async: !1,
                    data: {
                        'YWRkX21lc3NhZ2Vfb2ZmbGluZQ==': 'add_message_offline',
                        'Z3JvdXBpZA==': mi_group,
                        'bmFtZQ==': $('#contact_name').val(),
                        'ZW1haWw=': $('#contact_email').val(),
                        'cGhvbmU=': $('#contact_phone').val(),
                        'bWVzc2FnZQ==': $('#contact_message').val(),
                        'Y29va2llX2lk': localStorage.getItem("michat_support-jsCookie"),
                        'Y29va2llX3dpZGdldF9pZA==': jsGetVars.cookie_widget,
                        'dmlzaXRvcl9qaWQ=': 'user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-'),
                        'bGlua19wb3J0YWw=': jsGetVars.current_url,
                        'aG9zdF9uYW1l': jsGetVars.host_name,
                    },
                    success: function(data) {
                        $('#michat_button_offline').attr('disabled', 'disabled');
                        $('.header_text').text('-');
                        $('.header_text').css('color', jsThemeConfig.headerColor);
                        $('.michat_holder').css('height','150px');
                        // alert('Cảm ơn bạn đã gửi thông tin. Chúng tôi sẽ phản hồi lại trong thời gian sớm nhất.');
                        // $('#send_msg_m3').load('https://demo-2021.midesk.vn/chat/googleTag');
                        $('#send_msg_m3').html('<div style="display:flex;align-items: center;text-align: center;width: 100%;height: 100%;"><span style="padding: 5px;">Cảm ơn bạn đã gửi thông tin. Chúng tôi sẽ phản hồi lại trong thời gian sớm nhất.<span></div>');
                        // $('#googleTag').load('https://demo-2021.midesk.vn/chat/googleTag');
                        // location.reload()
                    }
                })
            }
        })
    });
    $(document).bind('connect', function() {
        Gab.connection = new Strophe.Connection(link_xmpp, {'keepalive': true});
        Gab.connection.connect('user_' + localStorage.getItem("michat_support-jsCookie") + '_' + jsGetVars.host_name.replace(/[:.\\/]/g, '-') + '@' + domain_xmpp + '/' + Math.random().toString(36).substr(2, 5), hash, Gab.on_connect)
    });
    var visitor_jid_queue;
    var agent_assign;
    var agent_jid;
    var iq = '';

    function your_roster_callback_function(iq) {
        Gab.connection.addHandler(Gab.on_presence, null, "presence");
        Gab.connection.send($pres())
    }
    $(document).bind('connected', function(ev, data) {
        if (username_xmpp == undefined) username_xmpp = 'Guest';
        if (email_xmpp == undefined) email_xmpp = '';
        if (phone_xmpp == undefined) phone_xmpp = '';
        visitor_jid_queue = Strophe.getBareJidFromJid(Gab.connection.jid);

        console.log($('#send_msg_m3').length);

        if(operatorsOnline > 0 && ($('#send_msg_m3').length == 0)){
            // setTimeout(function() {
                $.ajax({
                    url: 'https://demo-2021.midesk.vn/chat/addQueue',
                    type: "POST",
                    dataType: 'json',
                    async: !1,
                    data: {
                        'YWRkX3F1ZXVl': 'add_queue',
                        'Z3JvdXBpZA==': mi_group,
                        'dmlzaXRvcl9uYW1l': username_xmpp,
                        'dmlzaXRvcl9lbWFpbA==': email_xmpp,
                        'dmlzaXRvcl9waG9uZQ==': phone_xmpp,
                        'dmlzaXRvcl9qaWQ=': visitor_jid_queue.split('@')[0],
                        'bG9jYXRpb24=': '-',
                        'YnJvd3Nlcg==': jsGetVars.browser,
                        'cGxhdGZvcm0=': jsGetVars.os,
                        'aXBfYWRkcmVzcw==': jsGetVars.ip_address,
                        'dXNlcl9hZ2VudA==': jsGetVars.os,
                        'dXJsX3Zpc2l0': jsGetVars.current_url,
                        'cmVxdWVzdF9pZA==': request_id,
                        'Y29va2llX2lk': localStorage.getItem("michat_support-jsCookie"),
                        'c2Vzc2lvbl9pZA==': sessionStorage.getItem("michat_support-jsSession"),
                        'Y29va2llX3dpZGdldF9pZA==': jsGetVars.cookie_widget,
                        'aG9zdF9uYW1l': jsGetVars.host_name,
                        'c3VwcG9ydF90eXBlX2lk': support_type,
                        'dmVyaWZ5XzE=': visitor_jid_queue.split(/[@_]+/)[2],
                        'dmVyaWZ5XzI=': jsGetVars.host_name.replace(/[:.\\/]/g, '-'),
                        'X2FnZW50X2ludml0ZV9mbGFn': _agent_invite_flag,
                        'cmVmX3VybA==': jsGetVars.ref_url,
                        'b3BlcmF0b3JzT25saW5l': checkOperator2(),
                    },
                    success: function(data) {
                        var jid = data[0].jid;
                        agent_assign = data[0].user_id;
                        var jid_id = Gab.jid_to_id(jid);
                        iq = $iq({
                            type: 'get'
                        }).c('query', {
                            xmlns: 'jabber:iq:roster'
                        });
                        Gab.connection.sendIQ(iq, your_roster_callback_function);
                        Gab.connection.addHandler(Gab.on_message, null, "message", "chat");
                        var array_text = new Array();
                        var i = 0;
                        var text_test2 = '';
                        if (data[1].picture != '') {
                            user_pic = data[1].picture
                        } else {
                            user_pic = 'no_user_photo-v1.jpg'
                        }
                        if ($('#start_chat_m1').closest("form").attr('id')) {
                            $('#michat_header').html('<span class="header_text" style="color:#fff">' + jsThemeConfig.headerTextM1 + '</span>');
                            $('#username').val(localStorage.getItem("michat_support-nameClient"));
                            $('#useremail').val(localStorage.getItem("michat_support-emailClient"));
                            $('#phone').val(localStorage.getItem("michat_support-phoneClient"));
                            setSlideUpToggle("closed")
                        } else if ($('#send_msg_m3').closest("form").attr('id')) {
                            $('#michat_header').html('<span class="header_text" style="color:#fff">' + jsThemeConfig.headerTextM3 + '</span>');
                            $('#contact_name').val(localStorage.getItem("michat_support-nameClient"));
                            $('#contact_email').val(localStorage.getItem("michat_support-emailClient"));
                            setSlideUpToggle("closed")
                        } else {
                            if (_invite_chat_flag == !0) {
                                setSlideUpToggle("open");
                                _invite_chat_flag = !1
                            } else if (_start_chat_flag == !0) {
                                setSlideUpToggle("open");
                                _start_chat_flag = !1
                            }
                            var michat_header = '';
                            if (data[1].company) {
                                hotline = data[1].company
                            } else {
                                hotline = '19001238'
                            }
                            michat_header += '<table width="100%" style="font-size:14px;color:#fff;">\
                                <tr>\
                                    <td width="10px" class="header-back"><span id="click_back"><img style="width:12px" src="https://demo-2021.midesk.vn/public/webchat/images/arrow.png"></span></td>\
                                    <td width="10px" style="text-align:center;">\
                                        <div>\
                                            <img id="agent-avatar-header" src="' + dataAvatarAgent + user_pic + '">\
                                        </div>\
                                        <div id="online_icon"></div>\
                                        <div style="margin-top:-6px;"></div>\
                                    </td>\
                                    <td width="100px">\
                                        <div id="agent-title" data-id="'+data[1].id+'"><span>' + data[1].firstname + ' ' + data[1].lastname + '</span>';
                            if (jsThemeConfig.reviewChat == '1') {
                                michat_header += '<span style="float:right;padding-right:22px;"><span id="like_chat" style="cursor:pointer;padding: 5px;"><i class="fa fa-thumbs-o-up"></i></span><span id="unlike_chat" style="cursor:pointer;padding: 5px;"><i class="fa fa-thumbs-o-up" style="transform: rotate(180deg);"></i></span></span>'
                            }
                            michat_header += '</div>';
                            if (mi_group == 37) {
                                michat_header += '<div id="status-agent-title">Nhân viên tư vấn <br>(Hotline: ' + hotline + ')</div>'
                            } else {
                                michat_header += '<div id="status-agent-title">Nhân viên tư vấn</div>'
                            }
                            michat_header += '<div id="rating-and-transcript" style="display:none;">\
                                            <a class="rating-button rate-good" href="#" data-title="Rate as good" style="color:#fff"><i class="fa fa-thumbs-o-up" aria-hidden="true"></i></a> | \
                                            <a class="rating-button rate-bad" href="#" data-title="Rate as bad" style="color:#fff"><i class="fa fa-thumbs-o-down" aria-hidden="true"></i></a> | \
                                            <a href="#" data-title="Send the chat transcript to your e-mail" style="color:#fff"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>\
                                        </div>\
                                    </td>';
                            if (jsThemeConfig.reviewChat == '0') {
                                michat_header += '<td width="10px">\
                                            <span id="click_down" title="Thu nhỏ chat" class="michat_options_btn" style="font-size: 10px; display: inline;"><i class="fa fa-window-minimize"></i></span>\
                                        </td>'
                            } else {
                                michat_header += '<td width="10px">\
                                            <span id="click_down" title="Thu nhỏ chat" class="michat_options_btn" style="font-size: 10px; display: inline;"><i class="fa fa-window-minimize"></i></span>\
                                        </td>'
                            }
                            michat_header += '</tr>\
                            </table>';
                            $('#michat_header').html(michat_header);
                            load_mess_current(data[3]);
                            getMonitor()
                        }
                    }
                })
            // }, 1000)
        }else{
            // operatorsOnline > 0 ? (markup(), "1" == jsThemeConfig.requireAvatar && "img" == jsThemeConfig.userAvatarSelect && (document.getElementById("user_avatar_wrapper").style.display = "block", showAvatarSelect())) : "true" != jsGlobalConfig.offline_hide && messageInit()
            // console.log(111);
            // console.log(ev);
            // console.log(data);
            Gab.connection.send($pres().c('status').t('dnd or any status you want'));
        }
        
    });
    $(document).bind('attach', function(ev, data) {
        Gab.connection = new Strophe.Connection(link_xmpp, {'keepalive': true});
        if (operatorsOnline > 0) {
            // Gab.connection.attach(data.jid, data.sid, parseInt(data.rid, 10) + 1, Gab.on_connect)
            Gab.connection.attach(data.jid, data.sid, data.rid, Gab.on_connect)
        }
    });
    $(document).bind('disconnected', function() {});
    $(window).bind('unload', function() {
        if (Gab.connection !== null) {
            Gab.connection.pause();
            Gab.set_cookies()
        } else if ($.cookie('xmpp_jid') == 'null') {
            Gab.del_cookies()
        }
    });
    $(window).bind('beforeunload', function() {
        if (Gab.connection !== null) {
            Gab.connection.pause();
            Gab.set_cookies()
        } else if ($.cookie('xmpp_jid') == 'null') {
            Gab.del_cookies()
        }
    });
</script></body></html>